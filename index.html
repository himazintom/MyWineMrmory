<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyWineMemory - Ë∂ÖË©≥Á¥∞„ÉØ„Ç§„É≥Ë®òÈå≤&„ÇØ„Ç§„Ç∫„Ç¢„Éó„É™</title>
    
    <!-- PWAË®≠ÂÆö -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="WineMemory">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    
    <!-- È´òÂ∫¶„Å™„Çπ„Çø„Ç§„É´ -->
    <link rel="stylesheet" href="/advanced-style.css">
    
    <!-- Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="wine-glass-animation">
                <div class="glass">
                    <div class="wine"></div>
                </div>
            </div>
            <div class="loading-text">MyWineMemory</div>
            <div class="loading-subtext">ÊúÄÈ´ò„ÅÆ„ÉØ„Ç§„É≥‰ΩìÈ®ì„Çí„ÅäÂ±ä„Åë„Åó„Åæ„Åô</div>
        </div>
    </div>

    <!-- Professional Navigation Header -->
    <nav class="main-navbar">
        <div class="navbar-container">
            <div class="navbar-brand">
                <span class="brand-icon">üç∑</span>
                <span class="brand-text">MyWineMemory</span>
            </div>
            
            <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="„É°„Éã„É•„Éº„ÇíÈñã„Åè">
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
            </button>
            
            <div class="navbar-menu" id="navbarMenu">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <button class="nav-link nav-button" onclick="showSection('home')">
                            <span class="nav-icon">üè†</span>
                            <span class="nav-text">„Éõ„Éº„É†</span>
                        </button>
                    </li>
                    <li class="nav-item">
                        <a href="/quiz.html" class="nav-link">
                            <span class="nav-icon">üß†</span>
                            <span class="nav-text">„ÇØ„Ç§„Ç∫</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/analytics.html" class="nav-link">
                            <span class="nav-icon">üìä</span>
                            <span class="nav-text">ÂàÜÊûê</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/ai-evaluation.html" class="nav-link">
                            <span class="nav-icon">ü§ñ</span>
                            <span class="nav-text">AIÂàÜÊûê</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/learning-progress.html" class="nav-link">
                            <span class="nav-icon">üìà</span>
                            <span class="nav-text">Â≠¶ÁøíÈÄ≤Êçó</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/skill-tree.html" class="nav-link">
                            <span class="nav-icon">üå≥</span>
                            <span class="nav-text">„Çπ„Ç≠„É´„ÉÑ„É™„Éº</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link nav-button" onclick="showUltraAdvancedForm()">
                            <span class="nav-icon">üìù</span>
                            <span class="nav-text">Ë©≥Á¥∞Ë®òÈå≤</span>
                        </button>
                    </li>
                    <li class="nav-item">
                        <button id="theme-toggle" class="theme-toggle nav-link nav-button" aria-label="„ÉÜ„Éº„ÉûÂàá„ÇäÊõø„Åà">
                            <span class="theme-icon">üåô</span>
                            <span class="nav-text">„ÉÜ„Éº„Éû</span>
                        </button>
                    </li>
                    <li class="nav-item auth-nav" id="authNavItem">
                        <!-- „É≠„Ç∞„Ç§„É≥ÂâçË°®Á§∫ -->
                        <div id="loginNavView" class="auth-nav-content">
                            <button class="nav-link nav-button auth-button" onclick="signInWithGoogle()">
                                <span class="nav-icon">üë§</span>
                                <span class="nav-text">„É≠„Ç∞„Ç§„É≥</span>
                            </button>
                        </div>
                        
                        <!-- „É≠„Ç∞„Ç§„É≥ÂæåË°®Á§∫ -->
                        <div id="userNavView" class="auth-nav-content hidden">
                            <div class="user-nav-info">
                                <div class="user-details">
                                    <span class="user-name" id="userNavName">„É¶„Éº„Ç∂„Éº</span>
                                    <span class="user-email" id="userNavEmail"></span>
                                </div>
                                <button id="privacyToggle" class="privacy-toggle-btn" onclick="togglePrivacy()" title="Ë®òÈå≤„ÅÆÂÖ¨Èñã/ÈùûÂÖ¨Èñã„ÇíÂàá„ÇäÊõø„Åà">
                                    <span id="privacyText">ÈùûÂÖ¨Èñã</span>
                                </button>
                                <button class="logout-btn" onclick="confirmSignOut()" title="„É≠„Ç∞„Ç¢„Ç¶„Éà">
                                    „É≠„Ç∞„Ç¢„Ç¶„Éà
                                </button>
                            </div>
                        </div>
                        
                        <!-- „Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫ -->
                        <div id="authNavStatus" class="auth-status hidden"></div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Home Section -->
        <div id="homeSection" class="section active">
            <div class="hero-section">
                <h1 class="hero-title">üç∑ MyWineMemory</h1>
                <p class="hero-subtitle">„ÅÇ„Å™„Åü„ÅÆ„ÉØ„Ç§„É≥‰ΩìÈ®ì„ÇíË®òÈå≤„Åó„ÄÅÁü•Ë≠ò„ÇíÊ∑±„ÇÅ„Åæ„Åó„Çá„ÅÜ</p>
                <div class="hero-stats">
                    <div class="stat-item">
                        <span class="stat-number" id="totalWines">0</span>
                        <span class="stat-label">Ë®òÈå≤Êï∞</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="avgRating">0.0</span>
                        <span class="stat-label">Âπ≥ÂùáË©ï‰æ°</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="quizScore">0</span>
                        <span class="stat-label">„ÇØ„Ç§„Ç∫„Çπ„Ç≥„Ç¢</span>
                    </div>
                </div>
            </div>

            <!-- „ÉØ„Ç§„É≥Ê©üËÉΩ„Çª„ÇØ„Ç∑„Éß„É≥ -->
            <div class="wine-features" id="wineFeaturesSection">
                <div class="welcome-message">
                    <h2>üç∑ „ÉØ„Ç§„É≥„ÅÆ‰∏ñÁïå„Å∏„Çà„ÅÜ„Åì„Åù</h2>
                    <p>Ë©≥Á¥∞„Å™Ë®òÈå≤„Åß„ÄÅ„ÅÇ„Å™„Åü„ÅÆ„ÉØ„Ç§„É≥‰ΩìÈ®ì„Çí„Çà„ÇäË±ä„Åã„Å´</p>
                </div>
                
                <div class="feature-cards">
                    <div class="feature-card primary-card" onclick="showUltraAdvancedForm()">
                        <div class="feature-icon">üìù</div>
                        <h3>Ë©≥Á¥∞„ÉØ„Ç§„É≥Ë®òÈå≤</h3>
                        <p>„Éó„É≠„É¨„Éô„É´„ÅÆ„ÉÜ„Ç§„Çπ„ÉÜ„Ç£„É≥„Ç∞„Éé„Éº„Éà„ÇíË®òÈå≤</p>
                        <div class="card-action">Ë®òÈå≤„ÇíÈñãÂßã</div>
                    </div>
                </div>
                
                <!-- „Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫„Ç®„É™„Ç¢ -->
                <div id="authStatus" class="status hidden"></div>
            </div>

            <!-- „ÉØ„Ç§„É≥‰∏ÄË¶ß -->
            <div class="wine-showcase" id="wineShowcase">
                <h2>ÊúÄËøë„ÅÆË®òÈå≤</h2>
                <div id="recentWines" class="wine-grid">
                    <p class="empty-state">„É≠„Ç∞„Ç§„É≥„Åó„Å¶„ÉØ„Ç§„É≥„ÇíË®òÈå≤„Åó„Åæ„Åó„Çá„ÅÜ</p>
                </div>
            </div>
        </div>


        <!-- Ultra Advanced Wine Form Modal -->
        <div class="form-modal-overlay" id="ultraAdvancedForm" style="display: none;">
            <div class="form-modal">
                <div class="form-header">
                    <h2>Ë∂ÖË©≥Á¥∞„ÉØ„Ç§„É≥Ë®òÈå≤</h2>
                    <button type="button" class="close-form-btn" onclick="hideUltraAdvancedForm()">&times;</button>
                </div>
            
            <form id="ultraWineForm" onsubmit="saveUltraWineRecord(event)" class="ultra-form">
                <!-- Âü∫Êú¨ÊÉÖÂ†±„Çª„ÇØ„Ç∑„Éß„É≥ -->
                <div class="form-section">
                    <h3>„ÉØ„Ç§„É≥Âü∫Êú¨ÊÉÖÂ†±</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="wineName">„ÉØ„Ç§„É≥Âêç:</label>
                            <input type="text" id="wineName" name="wineName" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="producer">ÁîüÁî£ËÄÖ:</label>
                            <input type="text" id="producer" name="producer" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="region">Áî£Âú∞:</label>
                            <input type="text" id="region" name="region" placeholder="„Éï„É©„É≥„Çπ „Éú„É´„Éâ„Éº">
                        </div>
                        
                        <div class="form-group">
                            <label for="vintage">„É¥„Ç£„É≥„ÉÜ„Éº„Ç∏:</label>
                            <input type="number" id="vintage" name="vintage" min="1900" max="2030">
                        </div>
                        
                        <div class="form-group">
                            <label for="price">‰æ°Ê†º (ÂÜÜ):</label>
                            <input type="number" id="price" name="price" min="0">
                        </div>
                        
                        <div class="form-group">
                            <label for="purchaseDate">Ë≥ºÂÖ•Êó•:</label>
                            <input type="date" id="purchaseDate" name="purchaseDate">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>„ÉØ„Ç§„É≥„Çø„Ç§„Éó:</label>
                        <div class="radio-grid">
                            <label class="radio-item">
                                <input type="radio" name="wineType" value="red" required>
                                <span>Ëµ§„ÉØ„Ç§„É≥</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="wineType" value="white">
                                <span>ÁôΩ„ÉØ„Ç§„É≥</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="wineType" value="rose">
                                <span>„É≠„Çº„ÉØ„Ç§„É≥</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="wineType" value="sparkling">
                                <span>„Çπ„Éë„Éº„ÇØ„É™„É≥„Ç∞</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="grapes">„Éñ„Éâ„Ç¶ÂìÅÁ®Æ:</label>
                            <input type="text" id="grapes" name="grapes" placeholder="„Ç´„Éô„É´„Éç„Éª„ÇΩ„Éº„É¥„Ç£„Éã„É®„É≥ 70%, „É°„É´„É≠„Éº 30%">
                        </div>
                        <div class="form-group">
                            <label for="alcohol">„Ç¢„É´„Ç≥„Éº„É´Â∫¶Êï∞ (%):</label>
                            <input type="number" id="alcohol" name="alcohol" min="0" max="20" step="0.1">
                        </div>
                    </div>
                </div>
                
                <!-- Â§ñË¶≥ÂàÜÊûê„Çª„ÇØ„Ç∑„Éß„É≥ -->
                <div class="form-section">
                    <h3>Â§ñË¶≥ÂàÜÊûê</h3>
                    <div class="analysis-grid">
                        <div class="analysis-item">
                            <h4>Ëâ≤Ë™ø</h4>
                            <div class="radio-grid">
                                <label class="radio-item">
                                    <input type="radio" name="colorTone" value="purple">
                                    <span>Á¥´„Åå„Åã„Å£„Åü</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="colorTone" value="ruby">
                                    <span>„É´„Éì„ÉºËâ≤</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="colorTone" value="garnet">
                                    <span>„Ç¨„Éº„Éç„ÉÉ„ÉàËâ≤</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="colorTone" value="golden">
                                    <span>ÈáëËâ≤</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="analysis-item">
                            <h4>ÊøÉÊ∑°</h4>
                            <div class="radio-grid">
                                <label class="radio-item">
                                    <input type="radio" name="colorIntensity" value="pale">
                                    <span>Ê∑°„ÅÑ</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="colorIntensity" value="medium">
                                    <span>‰∏≠Á®ãÂ∫¶</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="colorIntensity" value="deep">
                                    <span>ÊøÉ„ÅÑ</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="analysis-item">
                            <h4>ÈÄèÊòéÂ∫¶</h4>
                            <div class="radio-grid">
                                <label class="radio-item">
                                    <input type="radio" name="clarity" value="clear">
                                    <span>ÊæÑÊòé</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="clarity" value="hazy">
                                    <span>„ÇÑ„ÇÑÊøÅ„Çä</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="clarity" value="opaque">
                                    <span>‰∏çÈÄèÊòé</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- È¶ô„ÇäÂàÜÊûê„Çª„ÇØ„Ç∑„Éß„É≥ -->
                <div class="form-section">
                    <h3>È¶ô„ÇäÂàÜÊûê</h3>
                    <div class="aroma-analysis">
                        <div class="aroma-category">
                            <h4>„Éï„É´„Éº„ÉÑÁ≥ª</h4>
                            <div class="checkbox-grid">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="aroma" value="blackberry">
                                    <span>„Éñ„É©„ÉÉ„ÇØ„Éô„É™„Éº</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="aroma" value="cherry">
                                    <span>„ÉÅ„Çß„É™„Éº</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="aroma" value="plum">
                                    <span>„Éó„É©„É†</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="aroma" value="citrus">
                                    <span>ÊüëÊ©òÁ≥ª</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="aroma-category">
                            <h4>„Çπ„Éë„Ç§„ÇπÁ≥ª</h4>
                            <div class="checkbox-grid">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="aroma" value="vanilla">
                                    <span>„Éê„Éã„É©</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="aroma" value="pepper">
                                    <span>„Ç≥„Ç∑„Éß„Ç¶</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="aroma" value="cinnamon">
                                    <span>„Ç∑„Éä„É¢„É≥</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="aroma" value="clove">
                                    <span>„ÇØ„É≠„Éº„Éñ</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="aroma-category">
                            <h4>„Ç¢„Éº„Ç∑„ÉºÁ≥ª</h4>
                            <div class="checkbox-grid">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="aroma" value="oak">
                                    <span>„Ç™„Éº„ÇØ</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="aroma" value="tobacco">
                                    <span>„Çø„Éê„Ç≥</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="aroma" value="leather">
                                    <span>Èù©</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="aroma" value="earth">
                                    <span>ÂúüÁ≥ª</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Âë≥„Çè„ÅÑÂàÜÊûê„Çª„ÇØ„Ç∑„Éß„É≥ -->
                <div class="form-section">
                    <h3>Âë≥„Çè„ÅÑÂàÜÊûê</h3>
                    <div class="taste-analysis">
                        <div class="taste-scale">
                            <label>ÁîòÂë≥ (1-5):</label>
                            <div class="star-rating" data-rating="sweetness">
                                <span class="star" data-value="1">‚òÖ</span>
                                <span class="star" data-value="2">‚òÖ</span>
                                <span class="star" data-value="3">‚òÖ</span>
                                <span class="star" data-value="4">‚òÖ</span>
                                <span class="star" data-value="5">‚òÖ</span>
                            </div>
                            <input type="hidden" name="sweetness" value="0">
                        </div>
                        
                        <div class="taste-scale">
                            <label>ÈÖ∏Âë≥ (1-5):</label>
                            <div class="star-rating" data-rating="acidity">
                                <span class="star" data-value="1">‚òÖ</span>
                                <span class="star" data-value="2">‚òÖ</span>
                                <span class="star" data-value="3">‚òÖ</span>
                                <span class="star" data-value="4">‚òÖ</span>
                                <span class="star" data-value="5">‚òÖ</span>
                            </div>
                            <input type="hidden" name="acidity" value="0">
                        </div>
                        
                        <div class="taste-scale">
                            <label>„Çø„É≥„Éã„É≥ (1-5):</label>
                            <div class="star-rating" data-rating="tannin">
                                <span class="star" data-value="1">‚òÖ</span>
                                <span class="star" data-value="2">‚òÖ</span>
                                <span class="star" data-value="3">‚òÖ</span>
                                <span class="star" data-value="4">‚òÖ</span>
                                <span class="star" data-value="5">‚òÖ</span>
                            </div>
                            <input type="hidden" name="tannin" value="0">
                        </div>
                        
                        <div class="taste-scale">
                            <label>„Éú„Éá„Ç£ (1-5):</label>
                            <div class="star-rating" data-rating="body">
                                <span class="star" data-value="1">‚òÖ</span>
                                <span class="star" data-value="2">‚òÖ</span>
                                <span class="star" data-value="3">‚òÖ</span>
                                <span class="star" data-value="4">‚òÖ</span>
                                <span class="star" data-value="5">‚òÖ</span>
                            </div>
                            <input type="hidden" name="body" value="0">
                        </div>
                        
                        <div class="taste-scale">
                            <label>„Éï„Ç£„Éã„ÉÉ„Ç∑„É• (1-5):</label>
                            <div class="star-rating" data-rating="finish">
                                <span class="star" data-value="1">‚òÖ</span>
                                <span class="star" data-value="2">‚òÖ</span>
                                <span class="star" data-value="3">‚òÖ</span>
                                <span class="star" data-value="4">‚òÖ</span>
                                <span class="star" data-value="5">‚òÖ</span>
                            </div>
                            <input type="hidden" name="finish" value="0">
                        </div>
                    </div>
                </div>
                
                <!-- Á∑èÂêàË©ï‰æ°„Çª„ÇØ„Ç∑„Éß„É≥ -->
                <div class="form-section">
                    <h3>Á∑èÂêàË©ï‰æ°</h3>
                    <div class="overall-rating">
                        <label>Á∑èÂêàË©ï‰æ° (1-5):</label>
                        <div class="star-rating" data-rating="wineRating">
                            <span class="star" data-value="1">‚òÖ</span>
                            <span class="star" data-value="2">‚òÖ</span>
                            <span class="star" data-value="3">‚òÖ</span>
                            <span class="star" data-value="4">‚òÖ</span>
                            <span class="star" data-value="5">‚òÖ</span>
                        </div>
                        <input type="hidden" name="wineRating" value="0" required>
                    </div>
                </div>
                
                <!-- Âë≥„Çè„ÅÑ„ÅÆÊÆµÈöéÂà•ÂàÜÊûê -->
                <div class="form-section">
                    <h3>Âë≥„Çè„ÅÑ„ÅÆÊÆµÈöéÂà•ÂàÜÊûê</h3>
                    <div class="taste-phases">
                        <div class="phase-item">
                            <h4>„Ç¢„Çø„ÉÉ„ÇØÔºàÁ¨¨‰∏ÄÂç∞Ë±°Ôºâ</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Âº∑Â∫¶:</label>
                                    <div class="radio-grid">
                                        <label class="radio-item">
                                            <input type="radio" name="attackIntensity" value="1">
                                            <span>Âº±„ÅÑ</span>
                                        </label>
                                        <label class="radio-item">
                                            <input type="radio" name="attackIntensity" value="2">
                                            <span>„ÇÑ„ÇÑÂº±„ÅÑ</span>
                                        </label>
                                        <label class="radio-item">
                                            <input type="radio" name="attackIntensity" value="3">
                                            <span>‰∏≠Á®ãÂ∫¶</span>
                                        </label>
                                        <label class="radio-item">
                                            <input type="radio" name="attackIntensity" value="4">
                                            <span>„ÇÑ„ÇÑÂº∑„ÅÑ</span>
                                        </label>
                                        <label class="radio-item">
                                            <input type="radio" name="attackIntensity" value="5">
                                            <span>Âº∑„ÅÑ</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="attackNotes">„Ç¢„Çø„ÉÉ„ÇØ„ÅÆ„É°„É¢:</label>
                                    <textarea id="attackNotes" name="attackNotes" rows="2" placeholder="Á¨¨‰∏ÄÂç∞Ë±°„ÅÆÂë≥„Çè„ÅÑ„ÇíË®òÈå≤"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div class="phase-item">
                            <h4>‰∏≠Áõ§ÔºàÁô∫Â±ïÔºâ</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Ë§áÈõë„Åï:</label>
                                    <div class="radio-grid">
                                        <label class="radio-item">
                                            <input type="radio" name="middleComplexity" value="1">
                                            <span>„Ç∑„É≥„Éó„É´</span>
                                        </label>
                                        <label class="radio-item">
                                            <input type="radio" name="middleComplexity" value="2">
                                            <span>„ÇÑ„ÇÑË§áÈõë</span>
                                        </label>
                                        <label class="radio-item">
                                            <input type="radio" name="middleComplexity" value="3">
                                            <span>Ë§áÈõë</span>
                                        </label>
                                        <label class="radio-item">
                                            <input type="radio" name="middleComplexity" value="4">
                                            <span>ÈùûÂ∏∏„Å´Ë§áÈõë</span>
                                        </label>
                                        <label class="radio-item">
                                            <input type="radio" name="middleComplexity" value="5">
                                            <span>Ê•µ„ÇÅ„Å¶Ë§áÈõë</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="middleNotes">‰∏≠Áõ§„ÅÆ„É°„É¢:</label>
                                    <textarea id="middleNotes" name="middleNotes" rows="2" placeholder="‰∏≠Áõ§„ÅÆÂë≥„Çè„ÅÑ„ÇíË®òÈå≤"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div class="phase-item">
                            <h4>„Éï„Ç£„Éã„ÉÉ„Ç∑„É•Ôºà‰ΩôÈüªÔºâ</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Èï∑„Åï:</label>
                                    <div class="radio-grid">
                                        <label class="radio-item">
                                            <input type="radio" name="finishLength" value="1">
                                            <span>Áü≠„ÅÑ</span>
                                        </label>
                                        <label class="radio-item">
                                            <input type="radio" name="finishLength" value="2">
                                            <span>„ÇÑ„ÇÑÁü≠„ÅÑ</span>
                                        </label>
                                        <label class="radio-item">
                                            <input type="radio" name="finishLength" value="3">
                                            <span>‰∏≠Á®ãÂ∫¶</span>
                                        </label>
                                        <label class="radio-item">
                                            <input type="radio" name="finishLength" value="4">
                                            <span>„ÇÑ„ÇÑÈï∑„ÅÑ</span>
                                        </label>
                                        <label class="radio-item">
                                            <input type="radio" name="finishLength" value="5">
                                            <span>ÈùûÂ∏∏„Å´Èï∑„ÅÑ</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="finishNotes">„Éï„Ç£„Éã„ÉÉ„Ç∑„É•„ÅÆ„É°„É¢:</label>
                                    <textarea id="finishNotes" name="finishNotes" rows="2" placeholder="‰ΩôÈüª„ÅÆÂç∞Ë±°„ÇíË®òÈå≤"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="notes">Ë©≥Á¥∞„É°„É¢:</label>
                        <textarea id="notes" name="notes" rows="4" placeholder="Âë≥„Çè„ÅÑ„ÄÅÂç∞Ë±°„ÄÅ„Éö„Ç¢„É™„É≥„Ç∞Êé®Â•®„Å™„Å©„ÇíË®òÈå≤"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="foodPairing">„Éï„Éº„Éâ„Éö„Ç¢„É™„É≥„Ç∞:</label>
                        <input type="text" id="foodPairing" name="foodPairing" placeholder="„Çπ„ÉÜ„Éº„Ç≠„ÄÅ„ÉÅ„Éº„Ç∫„ÄÅ„ÉÅ„Éß„Ç≥„É¨„Éº„Éà„Å™„Å©">
                    </div>
                    
                    <div class="form-group">
                        <label for="occasion">È£≤Áî®„Ç∑„Éº„É≥:</label>
                        <input type="text" id="occasion" name="occasion" placeholder="Ë™ïÁîüÊó•„ÄÅ„Éá„Ç£„Éä„Éº„ÄÅ„Éë„Éº„ÉÜ„Ç£„Éº„Å™„Å©">
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn primary-btn">Ë©≥Á¥∞Ë®òÈå≤„Çí‰øùÂ≠ò</button>
                    <button type="button" class="btn outline-btn" onclick="hideUltraAdvancedForm()">„Ç≠„É£„É≥„Çª„É´</button>
                </div>
            </form>
            </div>
        </div>

        <!-- „ÉØ„Ç§„É≥‰∏ÄË¶ß -->
        <div class="wine-list" id="wineListSection" style="display: none;">
            <h2>Ë®òÈå≤„Åï„Çå„Åü„ÉØ„Ç§„É≥</h2>
            <div id="wineRecords">
                <p>„É≠„Ç∞„Ç§„É≥„Åó„Å¶„ÉØ„Ç§„É≥„ÇíË®òÈå≤„Åó„Åæ„Åó„Çá„ÅÜ</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (CDN) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut as firebaseSignOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, where, limit, doc, setDoc, updateDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // FirebaseË®≠ÂÆö
        const firebaseConfig = {
            apiKey: "AIzaSyB6jnGUsdR9JDTZoDUq_QhM4Gr_gLVp3qA",
            authDomain: "mywinememory.firebaseapp.com",
            projectId: "mywinememory",
            storageBucket: "mywinememory.firebasestorage.app",
            messagingSenderId: "179280253269",
            appId: "1:179280253269:web:58330b5938412fafc21fdc",
            measurementId: "G-PP1B5425FD"
        };

        // FirebaseÂàùÊúüÂåñ
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let currentUser = null;
        let wineRecords = [];
        let userProfile = null;
        let authInitialized = false;


        // „É≠„Éº„Éá„Ç£„É≥„Ç∞ÁîªÈù¢„ÅÆÂà∂Âæ°
        function showLoadingOverlay(show, message = '') {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.style.display = 'flex';
                if (message) {
                    const subtext = overlay.querySelector('.loading-subtext');
                    subtext.textContent = message;
                }
            } else {
                overlay.style.display = 'none';
            }
        }

        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üç∑ MyWineMemory - Ultra AdvancedÁâà„ÇíÂàùÊúüÂåñ‰∏≠...');
            
            showLoadingOverlay(true, '„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÇíÊ∫ñÂÇô‰∏≠...');
            
            // ÂÖ±ÊúâURL„Åã„Å©„ÅÜ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            const pathParts = window.location.pathname.split('/');
            if (pathParts[1] === 'shared' && pathParts[2]) {
                // ÂÖ±Êúâ„Éö„Éº„Ç∏„ÅÆÂ†¥Âêà
                loadSharedProfile(pathParts[2]);
            }
            
            // ÊúÄ‰Ωé3ÁßíÈñì„ÅØ„É≠„Éº„Éá„Ç£„É≥„Ç∞„ÇíË°®Á§∫
            setTimeout(() => {
                showLoadingOverlay(false);
            }, 3000);

            initTheme();
            initMobileMenu();
            initStarRatings();
        });

        // Ë™çË®ºÁä∂ÊÖã„ÅÆÁõ£Ë¶ñ
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            authInitialized = true; // Ë™çË®ºÂàùÊúüÂåñÂÆå‰∫Ü
            
            if (user) {
                loadUserProfile();
                loadWineRecords();
                updateStats();
            }
            updateUI();
        });

        // UIÊõ¥Êñ∞
        function updateUI() {
            const loginNavView = document.getElementById('loginNavView');
            const userNavView = document.getElementById('userNavView');
            const userNavName = document.getElementById('userNavName');
            const userNavEmail = document.getElementById('userNavEmail');
            const wineFeaturesSection = document.getElementById('wineFeaturesSection');

            // Ë™çË®º„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
            if (!authInitialized) {
                return;
            }

            if (currentUser) {
                // „É≠„Ç∞„Ç§„É≥Âæå„ÅÆ„Éä„ÉìË°®Á§∫
                loginNavView.classList.add('hidden');
                userNavView.classList.remove('hidden');
                
                // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíË®≠ÂÆö
                userNavName.textContent = currentUser.displayName || '„É¶„Éº„Ç∂„Éº';
                userNavEmail.textContent = currentUser.email || '';
                
                // ÂÖÉ„ÅÆ„ÉØ„Ç§„É≥Ê©üËÉΩ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÂæ©ÂÖÉ
                restoreWineFeatures();
            } else {
                // „É≠„Ç∞„Ç§„É≥Ââç„ÅÆ„Éä„ÉìË°®Á§∫
                loginNavView.classList.remove('hidden');
                userNavView.classList.add('hidden');
                
                // „É≠„Ç∞„Ç§„É≥‰øÉÈÄ≤„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
                showLoginPrompt();
            }
        }

        // „ÉØ„Ç§„É≥Ê©üËÉΩ„ÅÆÂæ©ÂÖÉ
        function restoreWineFeatures() {
            const wineFeaturesSection = document.getElementById('wineFeaturesSection');
            
            // ÂÖÉ„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅåÊó¢„Å´„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Åù„ÅÆ„Åæ„ÅæË°®Á§∫
            if (!wineFeaturesSection.innerHTML.includes('login-required')) {
                wineFeaturesSection.style.display = 'block';
                return;
            }

            // ÂÖÉ„ÅÆ„ÉØ„Ç§„É≥Ê©üËÉΩ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÂæ©ÂÖÉ
            wineFeaturesSection.innerHTML = `
                <div class="welcome-message">
                    <h2>üç∑ „ÉØ„Ç§„É≥„ÅÆ‰∏ñÁïå„Å∏„Çà„ÅÜ„Åì„Åù</h2>
                    <p>Ë©≥Á¥∞„Å™Ë®òÈå≤„Åß„ÄÅ„ÅÇ„Å™„Åü„ÅÆ„ÉØ„Ç§„É≥‰ΩìÈ®ì„Çí„Çà„ÇäË±ä„Åã„Å´</p>
                </div>
                
                <div class="quick-actions">
                    <button class="action-btn primary" onclick="showUltraAdvancedForm()">
                        <span class="btn-icon">üìù</span>
                        <span class="btn-text">„ÉØ„Ç§„É≥„ÇíË®òÈå≤</span>
                    </button>
                    <a href="/quiz.html" class="action-btn secondary">
                        <span class="btn-icon">üß†</span>
                        <span class="btn-text">„ÇØ„Ç§„Ç∫„Å´ÊåëÊà¶</span>
                    </a>
                    <a href="/analytics.html" class="action-btn tertiary">
                        <span class="btn-icon">üìä</span>
                        <span class="btn-text">„Éá„Éº„ÇøÂàÜÊûê</span>
                    </a>
                </div>

                <div class="recent-wines" id="recentWines">
                    <h3>ÊúÄËøë„ÅÆË®òÈå≤</h3>
                    <div class="wine-grid" id="wineGrid">
                        <!-- „ÉØ„Ç§„É≥Ë®òÈå≤„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                    </div>
                </div>
            `;
            wineFeaturesSection.style.display = 'block';
        }

        // „É≠„Ç∞„Ç§„É≥‰øÉÈÄ≤ÁîªÈù¢„ÅÆË°®Á§∫
        function showLoginPrompt() {
            const wineFeaturesSection = document.getElementById('wineFeaturesSection');
            wineFeaturesSection.innerHTML = `
                <div class="login-required">
                    <h2>üç∑ MyWineMemory</h2>
                    <p>„ÉØ„Ç§„É≥„ÅÆË®òÈå≤„ÇíÂßã„ÇÅ„Çã„Å´„ÅØ„ÄÅ„Éò„ÉÉ„ÉÄ„Éº„Åã„Çâ„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                    <div class="login-features">
                        <div class="feature-preview">
                            <span class="preview-icon">üìù</span>
                            <span>Ë∂ÖË©≥Á¥∞„ÉÜ„Ç§„Çπ„ÉÜ„Ç£„É≥„Ç∞„Éé„Éº„Éà</span>
                        </div>
                        <div class="feature-preview">
                            <span class="preview-icon">üß†</span>
                            <span>„ÉØ„Ç§„É≥Áü•Ë≠ò„ÇØ„Ç§„Ç∫</span>
                        </div>
                        <div class="feature-preview">
                            <span class="preview-icon">üìä</span>
                            <span>„Éá„Éº„ÇøÂàÜÊûê„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // „É≠„Ç∞„Ç¢„Ç¶„ÉàÁ¢∫Ë™ç
        window.confirmSignOut = function() {
            if (confirm('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô„ÅãÔºü')) {
                signOut();
            }
        }

        // UUIDÁîüÊàê
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // „É¶„Éº„Ç∂„Éº„Éó„É≠„Éï„Ç£„Éº„É´Ë™≠„ÅøËæº„Åø
        async function loadUserProfile() {
            if (!currentUser) return;

            try {
                const userDocRef = doc(db, 'users', currentUser.uid);
                const userDoc = await getDoc(userDocRef);
                
                if (userDoc.exists()) {
                    userProfile = userDoc.data();
                } else {
                    // ÂàùÂõû„É≠„Ç∞„Ç§„É≥ÊôÇ„Å´„É¶„Éº„Ç∂„Éº„Éó„É≠„Éï„Ç£„Éº„É´‰ΩúÊàê
                    userProfile = {
                        displayName: currentUser.displayName,
                        email: currentUser.email,
                        photoURL: currentUser.photoURL,
                        isPublic: false,
                        shareToken: null,
                        createdAt: new Date()
                    };
                    await setDoc(userDocRef, userProfile);
                }
                
                // „Éó„É©„Ç§„Éê„Ç∑„Éº„Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
                updatePrivacyButton();
            } catch (error) {
                console.error('„É¶„Éº„Ç∂„Éº„Éó„É≠„Éï„Ç£„Éº„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó:', error);
            }
        }

        // „Éó„É©„Ç§„Éê„Ç∑„Éº„Éú„Çø„É≥„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
        function updatePrivacyButton() {
            const privacyText = document.getElementById('privacyText');
            const privacyToggle = document.getElementById('privacyToggle');
            
            if (userProfile && privacyText && privacyToggle) {
                if (userProfile.isPublic) {
                    privacyText.textContent = 'ÂÖ¨Èñã';
                    privacyToggle.title = 'Ë®òÈå≤„ÇíÈùûÂÖ¨Èñã„Å´„Åô„Çã';
                } else {
                    privacyText.textContent = 'ÈùûÂÖ¨Èñã';
                    privacyToggle.title = 'Ë®òÈå≤„ÇíÂÖ¨Èñã„Åô„Çã';
                }
            }
        }

        // „Éó„É©„Ç§„Éê„Ç∑„ÉºÂàá„ÇäÊõø„Åà
        window.togglePrivacy = async function() {
            if (!currentUser || !userProfile) {
                showStatus('„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
                return;
            }

            try {
                const userDocRef = doc(db, 'users', currentUser.uid);
                
                if (userProfile.isPublic) {
                    // ÂÖ¨Èñã‚ÜíÈùûÂÖ¨Èñã
                    await updateDoc(userDocRef, {
                        isPublic: false,
                        shareToken: null
                    });
                    userProfile.isPublic = false;
                    userProfile.shareToken = null;
                    
                    showStatus('Ë®òÈå≤„ÇíÈùûÂÖ¨Èñã„Å´„Åó„Åæ„Åó„Åü', 'success');
                } else {
                    // ÈùûÂÖ¨Èñã‚ÜíÂÖ¨Èñã
                    const shareToken = generateUUID();
                    await updateDoc(userDocRef, {
                        isPublic: true,
                        shareToken: shareToken
                    });
                    userProfile.isPublic = true;
                    userProfile.shareToken = shareToken;
                    
                    // ÂÖ±ÊúâURL„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº
                    const shareUrl = `${window.location.origin}/shared/${shareToken}`;
                    try {
                        await navigator.clipboard.writeText(shareUrl);
                        showCenterMessage('„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´ÂÖ±ÊúâURL„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');
                    } catch (error) {
                        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„Çí‰ΩøÁî®
                        const textarea = document.createElement('textarea');
                        textarea.value = shareUrl;
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textarea);
                        showCenterMessage('„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´ÂÖ±ÊúâURL„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');
                    }
                    
                    showStatus('Ë®òÈå≤„ÇíÂÖ¨Èñã„Åó„Åæ„Åó„Åü', 'success');
                }
                
                updatePrivacyButton();
            } catch (error) {
                showStatus('Ë®≠ÂÆö„ÅÆÂ§âÊõ¥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
            }
        }

        // ÁîªÈù¢‰∏≠Â§Æ„Å´„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
        function showCenterMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'center-message';
            messageDiv.textContent = message;
            messageDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--primary-color);
                color: white;
                padding: 20px 30px;
                border-radius: 12px;
                font-size: 16px;
                font-weight: 500;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                z-index: 10000;
                animation: fadeInOut 3s ease-in-out;
            `;
            
            document.body.appendChild(messageDiv);
            
            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ËøΩÂä†
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeInOut {
                    0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                    20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                    80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                    100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                }
            `;
            document.head.appendChild(style);
            
            // 3ÁßíÂæå„Å´ÂâäÈô§
            setTimeout(() => {
                if (document.body.contains(messageDiv)) {
                    document.body.removeChild(messageDiv);
                }
                if (document.head.contains(style)) {
                    document.head.removeChild(style);
                }
            }, 3000);
        }

        // ÂÖ±Êúâ„Éó„É≠„Éï„Ç£„Éº„É´Ë™≠„ÅøËæº„Åø
        async function loadSharedProfile(shareToken) {
            try {
                // shareToken„Åß„É¶„Éº„Ç∂„Éº„ÇíÊ§úÁ¥¢
                const usersRef = collection(db, 'users');
                const q = query(usersRef, where('shareToken', '==', shareToken));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    showSharedError('ÂÖ±ÊúâURL„ÅåÁÑ°Âäπ„Åæ„Åü„ÅØÊúüÈôêÂàá„Çå„Åß„Åô');
                    return;
                }
                
                const sharedUserDoc = querySnapshot.docs[0];
                const sharedUserData = sharedUserDoc.data();
                const sharedUserId = sharedUserDoc.id;
                
                if (!sharedUserData.isPublic) {
                    showSharedError('„Åì„ÅÆË®òÈå≤„ÅØÈùûÂÖ¨Èñã„Å´Ë®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åô');
                    return;
                }
                
                // ÂÖ±Êúâ„É¶„Éº„Ç∂„Éº„ÅÆ„ÉØ„Ç§„É≥Ë®òÈå≤„ÇíË™≠„ÅøËæº„Åø
                await loadSharedWineRecords(sharedUserId, sharedUserData);
                
            } catch (error) {
                console.error('ÂÖ±Êúâ„Éó„É≠„Éï„Ç£„Éº„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó:', error);
                showSharedError('„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        // ÂÖ±Êúâ„ÉØ„Ç§„É≥Ë®òÈå≤Ë™≠„ÅøËæº„Åø
        async function loadSharedWineRecords(userId, userData) {
            try {
                const q = query(
                    collection(db, 'wine_records'),
                    where('userId', '==', userId),
                    orderBy('createdAt', 'desc'),
                    limit(20)
                );
                
                const querySnapshot = await getDocs(q);
                const sharedWines = [];
                
                querySnapshot.forEach((doc) => {
                    sharedWines.push(doc.data());
                });
                
                // ÂÖ±Êúâ„Éö„Éº„Ç∏„ÅÆUI„ÇíË°®Á§∫
                showSharedProfile(userData, sharedWines);
                
            } catch (error) {
                console.error('ÂÖ±Êúâ„ÉØ„Ç§„É≥Ë®òÈå≤„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó:', error);
                showSharedError('„ÉØ„Ç§„É≥Ë®òÈå≤„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        // ÂÖ±Êúâ„Éó„É≠„Éï„Ç£„Éº„É´Ë°®Á§∫
        function showSharedProfile(userData, wineRecords) {
            const mainContainer = document.querySelector('.main-container');
            const totalWines = wineRecords.length;
            const avgRating = totalWines > 0 ? 
                (wineRecords.reduce((sum, wine) => sum + (wine.wineRating || 0), 0) / totalWines).toFixed(1) : 0;
            
            mainContainer.innerHTML = `
                <div class="shared-profile">
                    <div class="shared-header">
                        <div class="shared-user-info">
                            ${userData.photoURL ? `<img src="${userData.photoURL}" alt="${userData.displayName}" class="shared-avatar">` : ''}
                            <div class="shared-user-details">
                                <h1>üç∑ ${userData.displayName || '„ÉØ„Ç§„É≥ÊÑõÂ•ΩÂÆ∂'}„Åï„Çì„ÅÆ„ÉØ„Ç§„É≥Ë®òÈå≤</h1>
                                <p>ÂÖ¨Èñã„Åï„Çå„Åü„ÉØ„Ç§„É≥„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„Çí„ÅîË¶ß„Åè„Å†„Åï„ÅÑ</p>
                            </div>
                        </div>
                        
                        <div class="shared-stats">
                            <div class="shared-stat">
                                <span class="stat-number">${totalWines}</span>
                                <span class="stat-label">Ë®òÈå≤Êï∞</span>
                            </div>
                            <div class="shared-stat">
                                <span class="stat-number">${avgRating}</span>
                                <span class="stat-label">Âπ≥ÂùáË©ï‰æ°</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="shared-wines">
                        <h2>„ÉØ„Ç§„É≥Ë®òÈå≤</h2>
                        <div class="shared-wine-grid">
                            ${wineRecords.length > 0 ? wineRecords.map(wine => `
                                <div class="shared-wine-card">
                                    <h3>${wine.wineName}</h3>
                                    <p class="producer">${wine.producer}</p>
                                    ${wine.region ? `<p class="region">${wine.region}</p>` : ''}
                                    ${wine.vintage ? `<p class="vintage">${wine.vintage}Âπ¥</p>` : ''}
                                    <div class="rating">${'‚≠ê'.repeat(wine.wineRating || 0)} (${wine.wineRating}/5)</div>
                                    ${wine.notes ? `<p class="notes">${wine.notes}</p>` : ''}
                                    ${wine.foodPairing ? `<p class="pairing"><strong>„Éö„Ç¢„É™„É≥„Ç∞:</strong> ${wine.foodPairing}</p>` : ''}
                                </div>
                            `).join('') : '<p class="empty-shared">„Åæ„Å†„ÉØ„Ç§„É≥„ÅåË®òÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>'}
                        </div>
                    </div>
                    
                    <div class="shared-footer">
                        <a href="/" class="back-to-app">MyWineMemory„ÇíÂßã„ÇÅ„Çã</a>
                    </div>
                </div>
            `;
            
            // „Éä„Éì„Éê„Éº„ÇíÈö†„Åô
            document.querySelector('.main-navbar').style.display = 'none';
        }

        // ÂÖ±Êúâ„Ç®„É©„ÉºË°®Á§∫
        function showSharedError(message) {
            const mainContainer = document.querySelector('.main-container');
            mainContainer.innerHTML = `
                <div class="shared-error">
                    <div class="error-content">
                        <h1>üö´ „Ç¢„ÇØ„Çª„Çπ„Åß„Åç„Åæ„Åõ„Çì</h1>
                        <p>${message}</p>
                        <a href="/" class="back-to-app">MyWineMemory„Å´Êàª„Çã</a>
                    </div>
                </div>
            `;
            
            // „Éä„Éì„Éê„Éº„ÇíÈö†„Åô
            document.querySelector('.main-navbar').style.display = 'none';
        }

        // Google„É≠„Ç∞„Ç§„É≥
        window.signInWithGoogle = async function() {
            console.log('üîê Google login attempt started');
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                console.log('‚úÖ Google login successful');
                showStatus('„É≠„Ç∞„Ç§„É≥„Å´ÊàêÂäü„Åó„Åæ„Åó„Åü', 'success');
            } catch (error) {
                console.error('‚ùå Google login failed:', error);
                showStatus('„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
            }
        }

        // „É≠„Ç∞„Ç¢„Ç¶„Éà
        window.signOut = async function() {
            try {
                await firebaseSignOut(auth);
                showStatus('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü', 'success');
                document.getElementById('wineRecords').innerHTML = '<p>„É≠„Ç∞„Ç§„É≥„Åó„Å¶„ÉØ„Ç§„É≥„ÇíË®òÈå≤„Åó„Åæ„Åó„Çá„ÅÜ</p>';
                wineRecords = [];
                updateStats();
            } catch (error) {
                showStatus('„É≠„Ç∞„Ç¢„Ç¶„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }


        // Ë∂ÖË©≥Á¥∞„Éï„Ç©„Éº„É†Ë°®Á§∫
        window.showUltraAdvancedForm = function() {
            if (!currentUser) {
                showStatus('„Éò„ÉÉ„ÉÄ„Éº„Åã„Çâ„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            document.getElementById('ultraAdvancedForm').style.display = 'block';
        }

        // Ë∂ÖË©≥Á¥∞„Éï„Ç©„Éº„É†ÈùûË°®Á§∫
        window.hideUltraAdvancedForm = function() {
            document.getElementById('ultraAdvancedForm').style.display = 'none';
            document.getElementById('ultraWineForm').reset();
            resetStarRatings();
        }

        // Ë∂ÖË©≥Á¥∞„ÉØ„Ç§„É≥Ë®òÈå≤‰øùÂ≠ò
        window.saveUltraWineRecord = async function(event) {
            event.preventDefault();
            
            if (!currentUser) {
                showStatus('„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô', 'error');
                return;
            }

            const formData = new FormData(event.target);
            const wineData = {
                wineName: formData.get('wineName'),
                producer: formData.get('producer'),
                region: formData.get('region'),
                vintage: parseInt(formData.get('vintage')) || null,
                price: parseInt(formData.get('price')) || null,
                purchaseDate: formData.get('purchaseDate'),
                wineType: formData.get('wineType'),
                grapes: formData.get('grapes'),
                alcohol: parseFloat(formData.get('alcohol')) || null,
                colorTone: formData.get('colorTone'),
                colorIntensity: formData.get('colorIntensity'),
                clarity: formData.get('clarity'),
                aroma: formData.getAll('aroma'),
                sweetness: parseInt(formData.get('sweetness')),
                acidity: parseInt(formData.get('acidity')),
                tannin: parseInt(formData.get('tannin')),
                body: parseInt(formData.get('body')),
                finish: parseInt(formData.get('finish')),
                wineRating: parseInt(formData.get('wineRating')),
                // Âë≥„Çè„ÅÑÊÆµÈöéÂà•ÂàÜÊûê
                attackIntensity: parseInt(formData.get('attackIntensity')) || null,
                attackNotes: formData.get('attackNotes'),
                middleComplexity: parseInt(formData.get('middleComplexity')) || null,
                middleNotes: formData.get('middleNotes'),
                finishLength: parseInt(formData.get('finishLength')) || null,
                finishNotes: formData.get('finishNotes'),
                // „Åù„ÅÆ‰ªñ
                notes: formData.get('notes'),
                foodPairing: formData.get('foodPairing'),
                occasion: formData.get('occasion'),
                userId: currentUser.uid,
                createdAt: new Date()
            };

            try {
                await addDoc(collection(db, 'wine_records'), wineData);
                showStatus('Ë©≥Á¥∞„ÉØ„Ç§„É≥Ë®òÈå≤„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ', 'success');
                hideUltraAdvancedForm();
                loadWineRecords();
                updateStats();
            } catch (error) {
                showStatus('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
            }
        }

        // „ÉØ„Ç§„É≥Ë®òÈå≤Ë™≠„ÅøËæº„Åø
        async function loadWineRecords() {
            if (!currentUser) return;

            try {
                const q = query(
                    collection(db, 'wine_records'),
                    where('userId', '==', currentUser.uid),
                    orderBy('createdAt', 'desc'),
                    limit(6)
                );
                
                const querySnapshot = await getDocs(q);
                const recentWinesContainer = document.getElementById('recentWines');
                
                if (querySnapshot.empty) {
                    recentWinesContainer.innerHTML = '<p class="empty-state">„Åæ„Å†„ÉØ„Ç§„É≥„ÅåË®òÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇÊúÄÂàù„ÅÆ„ÉØ„Ç§„É≥„ÇíË®òÈå≤„Åó„Åæ„Åó„Çá„ÅÜÔºÅ</p>';
                    return;
                }

                let html = '';
                wineRecords = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    wineRecords.push(data);
                    html += `
                        <div class="wine-card">
                            <h3>${data.wineName}</h3>
                            <p class="producer">${data.producer}</p>
                            ${data.region ? `<p class="region">${data.region}</p>` : ''}
                            <div class="rating">${'‚≠ê'.repeat(data.wineRating || 0)}</div>
                            ${data.notes ? `<p class="notes">${data.notes.substring(0, 100)}...</p>` : ''}
                        </div>
                    `;
                });
                
                recentWinesContainer.innerHTML = html;
            } catch (error) {
                showStatus('„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
            }
        }

        // Áµ±Ë®àÊÉÖÂ†±Êõ¥Êñ∞
        function updateStats() {
            const totalWinesEl = document.getElementById('totalWines');
            const avgRatingEl = document.getElementById('avgRating');
            
            if (wineRecords.length > 0) {
                totalWinesEl.textContent = wineRecords.length;
                const avgRating = wineRecords.reduce((sum, wine) => sum + (wine.wineRating || 0), 0) / wineRecords.length;
                avgRatingEl.textContent = avgRating.toFixed(1);
            } else {
                totalWinesEl.textContent = '0';
                avgRatingEl.textContent = '0.0';
            }
        }


        // „Çπ„Çø„ÉºË©ï‰æ°„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ
        function initStarRatings() {
            const starRatings = document.querySelectorAll('.star-rating');
            
            starRatings.forEach(rating => {
                const stars = rating.querySelectorAll('.star');
                const ratingName = rating.getAttribute('data-rating');
                const hiddenInput = document.querySelector(`input[name="${ratingName}"]`);
                
                stars.forEach(star => {
                    star.addEventListener('click', function() {
                        const value = this.getAttribute('data-value');
                        hiddenInput.value = value;
                        
                        stars.forEach((s, index) => {
                            if (index < value) {
                                s.classList.add('active');
                            } else {
                                s.classList.remove('active');
                            }
                        });
                    });
                });
            });
        }

        function resetStarRatings() {
            const stars = document.querySelectorAll('.star');
            const hiddenInputs = document.querySelectorAll('.star-rating + input[type="hidden"]');
            
            stars.forEach(star => star.classList.remove('active'));
            hiddenInputs.forEach(input => input.value = '0');
        }

        // „ÉÜ„Éº„ÉûÂàá„ÇäÊõø„ÅàÊ©üËÉΩ
        function initTheme() {
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = document.querySelector('.theme-icon');
            
            const savedTheme = localStorage.getItem('theme') || 
                (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            
            setTheme(savedTheme);
            
            themeToggle.addEventListener('click', () => {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                setTheme(newTheme);
                localStorage.setItem('theme', newTheme);
            });
            
            function setTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                themeIcon.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            }
        }

        // „É¢„Éê„Ç§„É´„É°„Éã„É•„ÉºÂà∂Âæ°
        function initMobileMenu() {
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const navbarMenu = document.getElementById('navbarMenu');
            
            if (mobileMenuToggle && navbarMenu) {
                mobileMenuToggle.addEventListener('click', () => {
                    mobileMenuToggle.classList.toggle('active');
                    navbarMenu.classList.toggle('active');
                });
                
                const navLinks = navbarMenu.querySelectorAll('.nav-link');
                navLinks.forEach(link => {
                    link.addEventListener('click', () => {
                        mobileMenuToggle.classList.remove('active');
                        navbarMenu.classList.remove('active');
                    });
                });
                
                document.addEventListener('click', (e) => {
                    if (!mobileMenuToggle.contains(e.target) && !navbarMenu.contains(e.target)) {
                        mobileMenuToggle.classList.remove('active');
                        navbarMenu.classList.remove('active');
                    }
                });
            }
        }

        // „Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫ÔºàÁîªÈù¢‰∏≠Â§ÆÔºâ
        function showStatus(message, type) {
            // Êó¢Â≠ò„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂâäÈô§
            const existingMessage = document.querySelector('.center-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            // Êñ∞„Åó„ÅÑ„É°„ÉÉ„Çª„Éº„Ç∏Ë¶ÅÁ¥†„Çí‰ΩúÊàê
            const messageEl = document.createElement('div');
            messageEl.className = `center-message ${type}`;
            messageEl.textContent = message;
            
            // body„Å´ËøΩÂä†
            document.body.appendChild(messageEl);
            
            // 3ÁßíÂæå„Å´ÂâäÈô§
            setTimeout(() => {
                if (messageEl.parentNode) {
                    messageEl.remove();
                }
            }, 3000);
        }

        console.log('üç∑ MyWineMemory Ultra Advanced initialized successfully');
    </script>

    <!-- Service WorkerÁôªÈå≤ -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then((registration) => {
                    console.log('Service Worker registered');
                    
                    // Êõ¥Êñ∞„ÅÆÁ¢∫Ë™ç
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('New Service Worker found, installing...');
                        
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed') {
                                if (navigator.serviceWorker.controller) {
                                    // Êó¢Â≠ò„ÅÆSW„Åå„ÅÇ„ÇãÂ†¥Âêà„ÄÅÊõ¥Êñ∞„ÇíÈÄöÁü•
                                    console.log('New content available, showing update notification');
                                    showUpdateAvailable();
                                } else {
                                    // ÂàùÂõû„Ç§„É≥„Çπ„Éà„Éº„É´„ÅÆÂ†¥Âêà
                                    console.log('Content cached for offline use');
                                }
                            }
                        });
                    });
                    
                    // ÂÆöÊúüÁöÑ„Å´Êõ¥Êñ∞„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                    setInterval(() => {
                        registration.update();
                    }, 60000); // 1ÂàÜ„Åî„Å®
                })
                .catch(err => console.log('Service Worker registration failed:', err));
                
            // Service Worker„Åã„Çâ„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂèó‰ø°
            navigator.serviceWorker.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'SKIP_WAITING') {
                    window.location.reload();
                }
            });
        }

        function showUpdateAvailable() {
            const updateBanner = document.createElement('div');
            updateBanner.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: #4CAF50;
                color: white;
                padding: 10px;
                text-align: center;
                z-index: 10000;
                box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            `;
            updateBanner.innerHTML = `
                Êñ∞„Åó„ÅÑ„Éê„Éº„Ç∏„Éß„É≥„ÅåÂà©Áî®ÂèØËÉΩ„Åß„ÅôÔºÅ
                <button onclick="updateApp()" style="margin-left: 10px; padding: 5px 10px; background: white; color: #4CAF50; border: none; border-radius: 3px; cursor: pointer;">
                    Êõ¥Êñ∞
                </button>
                <button onclick="this.parentElement.remove()" style="margin-left: 5px; padding: 5px 10px; background: transparent; color: white; border: 1px solid white; border-radius: 3px; cursor: pointer;">
                    Âæå„Åß
                </button>
            `;
            document.body.appendChild(updateBanner);
        }

        window.updateApp = function() {
            // „Ç≠„É£„ÉÉ„Ç∑„É•„Çí„ÇØ„É™„Ç¢
            if ('caches' in window) {
                caches.keys().then(cacheNames => {
                    return Promise.all(
                        cacheNames.map(cacheName => {
                            console.log('Deleting cache:', cacheName);
                            return caches.delete(cacheName);
                        })
                    );
                }).then(() => {
                    console.log('All caches cleared');
                    // Service Worker„Å´skip waiting„ÇíÊåáÁ§∫
                    if (navigator.serviceWorker.controller) {
                        navigator.serviceWorker.controller.postMessage({ type: 'SKIP_WAITING' });
                    }
                    // Âº∑Âà∂„É™„É≠„Éº„Éâ
                    window.location.reload(true);
                });
            } else {
                // Service Worker„Å´skip waiting„ÇíÊåáÁ§∫
                if (navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({ type: 'SKIP_WAITING' });
                }
                window.location.reload(true);
            }
        }
    </script>
</body>
</html>