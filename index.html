<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyWineMemory - 超詳細ワイン記録&クイズアプリ</title>
    
    <!-- PWA設定 -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="WineMemory">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    
    <!-- 高度なスタイル -->
    <link rel="stylesheet" href="/advanced-style.css">
    
    <!-- Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="wine-glass-animation">
                <div class="glass">
                    <div class="wine"></div>
                </div>
            </div>
            <div class="loading-text">MyWineMemory</div>
            <div class="loading-subtext">最高のワイン体験をお届けします</div>
        </div>
    </div>

    <!-- Professional Navigation Header -->
    <nav class="main-navbar">
        <div class="navbar-container">
            <div class="navbar-brand">
                <span class="brand-icon">🍷</span>
                <span class="brand-text">MyWineMemory</span>
            </div>
            
            <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="メニューを開く">
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
            </button>
            
            <div class="navbar-menu" id="navbarMenu">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <button class="nav-link nav-button" onclick="showSection('home')">
                            <span class="nav-icon">🏠</span>
                            <span class="nav-text">ホーム</span>
                        </button>
                    </li>
                    <li class="nav-item">
                        <a href="/quiz.html" class="nav-link">
                            <span class="nav-icon">🧠</span>
                            <span class="nav-text">クイズ</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/analytics.html" class="nav-link">
                            <span class="nav-icon">📊</span>
                            <span class="nav-text">分析</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/ai-evaluation.html" class="nav-link">
                            <span class="nav-icon">🤖</span>
                            <span class="nav-text">AI分析</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/learning-progress.html" class="nav-link">
                            <span class="nav-icon">📈</span>
                            <span class="nav-text">学習進捗</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/skill-tree.html" class="nav-link">
                            <span class="nav-icon">🌳</span>
                            <span class="nav-text">スキルツリー</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link nav-button" onclick="showUltraAdvancedForm()">
                            <span class="nav-icon">📝</span>
                            <span class="nav-text">詳細記録</span>
                        </button>
                    </li>
                    <li class="nav-item">
                        <button id="theme-toggle" class="theme-toggle nav-link nav-button" aria-label="テーマ切り替え">
                            <span class="theme-icon">🌙</span>
                            <span class="nav-text">テーマ</span>
                        </button>
                    </li>
                    <li class="nav-item auth-nav" id="authNavItem">
                        <!-- ログイン前表示 -->
                        <div id="loginNavView" class="auth-nav-content">
                            <button class="nav-link nav-button auth-button" onclick="signInWithGoogle()">
                                <span class="nav-icon">👤</span>
                                <span class="nav-text">ログイン</span>
                            </button>
                        </div>
                        
                        <!-- ログイン後表示 -->
                        <div id="userNavView" class="auth-nav-content hidden">
                            <div class="user-nav-info">
                                <div class="user-details">
                                    <span class="user-name" id="userNavName">ユーザー</span>
                                    <span class="user-email" id="userNavEmail"></span>
                                </div>
                                <button id="privacyToggle" class="privacy-toggle-btn" onclick="togglePrivacy()" title="記録の公開/非公開を切り替え">
                                    <span id="privacyText">非公開</span>
                                </button>
                                <button class="logout-btn" onclick="confirmSignOut()" title="ログアウト">
                                    ログアウト
                                </button>
                            </div>
                        </div>
                        
                        <!-- ステータス表示 -->
                        <div id="authNavStatus" class="auth-status hidden"></div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Home Section -->
        <div id="homeSection" class="section active">
            <div class="hero-section">
                <h1 class="hero-title">🍷 MyWineMemory</h1>
                <p class="hero-subtitle">あなたのワイン体験を記録し、知識を深めましょう</p>
                <div class="hero-stats">
                    <div class="stat-item">
                        <span class="stat-number" id="totalWines">0</span>
                        <span class="stat-label">記録数</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="avgRating">0.0</span>
                        <span class="stat-label">平均評価</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="quizScore">0</span>
                        <span class="stat-label">クイズスコア</span>
                    </div>
                </div>
            </div>

            <!-- ワイン機能セクション -->
            <div class="wine-features" id="wineFeaturesSection">
                <div class="welcome-message">
                    <h2>🍷 ワインの世界へようこそ</h2>
                    <p>詳細な記録で、あなたのワイン体験をより豊かに</p>
                </div>
                
                <div class="feature-cards">
                    <div class="feature-card primary-card" onclick="showUltraAdvancedForm()">
                        <div class="feature-icon">📝</div>
                        <h3>詳細ワイン記録</h3>
                        <p>プロレベルのテイスティングノートを記録</p>
                        <div class="card-action">記録を開始</div>
                    </div>
                </div>
                
                <!-- ステータス表示エリア -->
                <div id="authStatus" class="status hidden"></div>
            </div>

            <!-- ワイン一覧 -->
            <div class="wine-showcase" id="wineShowcase">
                <h2>最近の記録</h2>
                <div id="recentWines" class="wine-grid">
                    <p class="empty-state">ログインしてワインを記録しましょう</p>
                </div>
            </div>
        </div>


        <!-- Ultra Advanced Wine Form Modal -->
        <div class="form-modal-overlay" id="ultraAdvancedForm" style="display: none;">
            <div class="form-modal">
                <div class="form-header">
                    <h2>超詳細ワイン記録</h2>
                    <button type="button" class="close-form-btn" onclick="hideUltraAdvancedForm()">&times;</button>
                </div>
            
            <form id="ultraWineForm" onsubmit="saveUltraWineRecord(event)" class="ultra-form">
                <!-- 基本情報セクション -->
                <div class="form-section">
                    <h3>ワイン基本情報</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="wineName">ワイン名:</label>
                            <input type="text" id="wineName" name="wineName" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="producer">生産者:</label>
                            <input type="text" id="producer" name="producer" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="region">産地:</label>
                            <input type="text" id="region" name="region" placeholder="フランス ボルドー">
                        </div>
                        
                        <div class="form-group">
                            <label for="vintage">ヴィンテージ:</label>
                            <input type="number" id="vintage" name="vintage" min="1900" max="2030">
                        </div>
                        
                        <div class="form-group">
                            <label for="price">価格 (円):</label>
                            <input type="number" id="price" name="price" min="0">
                        </div>
                        
                        <div class="form-group">
                            <label for="purchaseDate">購入日:</label>
                            <input type="date" id="purchaseDate" name="purchaseDate">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>ワインタイプ:</label>
                        <div class="radio-grid">
                            <label class="radio-item">
                                <input type="radio" name="wineType" value="red" required>
                                <span>赤ワイン</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="wineType" value="white">
                                <span>白ワイン</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="wineType" value="rose">
                                <span>ロゼワイン</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="wineType" value="sparkling">
                                <span>スパークリング</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="grapes">ブドウ品種:</label>
                            <input type="text" id="grapes" name="grapes" placeholder="カベルネ・ソーヴィニヨン 70%, メルロー 30%">
                        </div>
                        <div class="form-group">
                            <label for="alcohol">アルコール度数 (%):</label>
                            <input type="number" id="alcohol" name="alcohol" min="0" max="20" step="0.1">
                        </div>
                    </div>
                </div>
                
                <!-- 外観分析セクション -->
                <div class="form-section">
                    <h3>外観分析</h3>
                    <div class="analysis-grid">
                        <div class="analysis-item">
                            <h4>色調</h4>
                            <div class="radio-grid">
                                <label class="radio-item">
                                    <input type="radio" name="colorTone" value="purple">
                                    <span>紫がかった</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="colorTone" value="ruby">
                                    <span>ルビー色</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="colorTone" value="garnet">
                                    <span>ガーネット色</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="colorTone" value="golden">
                                    <span>金色</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="analysis-item">
                            <h4>濃淡</h4>
                            <div class="radio-grid">
                                <label class="radio-item">
                                    <input type="radio" name="colorIntensity" value="pale">
                                    <span>淡い</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="colorIntensity" value="medium">
                                    <span>中程度</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="colorIntensity" value="deep">
                                    <span>濃い</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="analysis-item">
                            <h4>透明度</h4>
                            <div class="radio-grid">
                                <label class="radio-item">
                                    <input type="radio" name="clarity" value="clear">
                                    <span>澄明</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="clarity" value="hazy">
                                    <span>やや濁り</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="clarity" value="opaque">
                                    <span>不透明</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 香り分析セクション -->
                <div class="form-section">
                    <h3>香り分析</h3>
                    <div class="aroma-analysis">
                        <div class="aroma-category">
                            <h4>フルーツ系</h4>
                            <div class="checkbox-grid">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="aroma" value="blackberry">
                                    <span>ブラックベリー</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="aroma" value="cherry">
                                    <span>チェリー</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="aroma" value="plum">
                                    <span>プラム</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="aroma" value="citrus">
                                    <span>柑橘系</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="aroma-category">
                            <h4>スパイス系</h4>
                            <div class="checkbox-grid">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="aroma" value="vanilla">
                                    <span>バニラ</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="aroma" value="pepper">
                                    <span>コショウ</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="aroma" value="cinnamon">
                                    <span>シナモン</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="aroma" value="clove">
                                    <span>クローブ</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="aroma-category">
                            <h4>アーシー系</h4>
                            <div class="checkbox-grid">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="aroma" value="oak">
                                    <span>オーク</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="aroma" value="tobacco">
                                    <span>タバコ</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="aroma" value="leather">
                                    <span>革</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="aroma" value="earth">
                                    <span>土系</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 味わい分析セクション -->
                <div class="form-section">
                    <h3>味わい分析</h3>
                    <div class="taste-analysis">
                        <div class="taste-scale">
                            <label>甘味 (1-5):</label>
                            <div class="star-rating" data-rating="sweetness">
                                <span class="star" data-value="1">★</span>
                                <span class="star" data-value="2">★</span>
                                <span class="star" data-value="3">★</span>
                                <span class="star" data-value="4">★</span>
                                <span class="star" data-value="5">★</span>
                            </div>
                            <input type="hidden" name="sweetness" value="0">
                        </div>
                        
                        <div class="taste-scale">
                            <label>酸味 (1-5):</label>
                            <div class="star-rating" data-rating="acidity">
                                <span class="star" data-value="1">★</span>
                                <span class="star" data-value="2">★</span>
                                <span class="star" data-value="3">★</span>
                                <span class="star" data-value="4">★</span>
                                <span class="star" data-value="5">★</span>
                            </div>
                            <input type="hidden" name="acidity" value="0">
                        </div>
                        
                        <div class="taste-scale">
                            <label>タンニン (1-5):</label>
                            <div class="star-rating" data-rating="tannin">
                                <span class="star" data-value="1">★</span>
                                <span class="star" data-value="2">★</span>
                                <span class="star" data-value="3">★</span>
                                <span class="star" data-value="4">★</span>
                                <span class="star" data-value="5">★</span>
                            </div>
                            <input type="hidden" name="tannin" value="0">
                        </div>
                        
                        <div class="taste-scale">
                            <label>ボディ (1-5):</label>
                            <div class="star-rating" data-rating="body">
                                <span class="star" data-value="1">★</span>
                                <span class="star" data-value="2">★</span>
                                <span class="star" data-value="3">★</span>
                                <span class="star" data-value="4">★</span>
                                <span class="star" data-value="5">★</span>
                            </div>
                            <input type="hidden" name="body" value="0">
                        </div>
                        
                        <div class="taste-scale">
                            <label>フィニッシュ (1-5):</label>
                            <div class="star-rating" data-rating="finish">
                                <span class="star" data-value="1">★</span>
                                <span class="star" data-value="2">★</span>
                                <span class="star" data-value="3">★</span>
                                <span class="star" data-value="4">★</span>
                                <span class="star" data-value="5">★</span>
                            </div>
                            <input type="hidden" name="finish" value="0">
                        </div>
                    </div>
                </div>
                
                <!-- 総合評価セクション -->
                <div class="form-section">
                    <h3>総合評価</h3>
                    <div class="overall-rating">
                        <label>総合評価 (1-5):</label>
                        <div class="star-rating" data-rating="wineRating">
                            <span class="star" data-value="1">★</span>
                            <span class="star" data-value="2">★</span>
                            <span class="star" data-value="3">★</span>
                            <span class="star" data-value="4">★</span>
                            <span class="star" data-value="5">★</span>
                        </div>
                        <input type="hidden" name="wineRating" value="0" required>
                    </div>
                </div>
                
                <!-- 味わいの段階別分析 -->
                <div class="form-section">
                    <h3>味わいの段階別分析</h3>
                    <div class="taste-phases">
                        <div class="phase-item">
                            <h4>アタック（第一印象）</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>強度:</label>
                                    <div class="radio-grid">
                                        <label class="radio-item">
                                            <input type="radio" name="attackIntensity" value="1">
                                            <span>弱い</span>
                                        </label>
                                        <label class="radio-item">
                                            <input type="radio" name="attackIntensity" value="2">
                                            <span>やや弱い</span>
                                        </label>
                                        <label class="radio-item">
                                            <input type="radio" name="attackIntensity" value="3">
                                            <span>中程度</span>
                                        </label>
                                        <label class="radio-item">
                                            <input type="radio" name="attackIntensity" value="4">
                                            <span>やや強い</span>
                                        </label>
                                        <label class="radio-item">
                                            <input type="radio" name="attackIntensity" value="5">
                                            <span>強い</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="attackNotes">アタックのメモ:</label>
                                    <textarea id="attackNotes" name="attackNotes" rows="2" placeholder="第一印象の味わいを記録"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div class="phase-item">
                            <h4>中盤（発展）</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>複雑さ:</label>
                                    <div class="radio-grid">
                                        <label class="radio-item">
                                            <input type="radio" name="middleComplexity" value="1">
                                            <span>シンプル</span>
                                        </label>
                                        <label class="radio-item">
                                            <input type="radio" name="middleComplexity" value="2">
                                            <span>やや複雑</span>
                                        </label>
                                        <label class="radio-item">
                                            <input type="radio" name="middleComplexity" value="3">
                                            <span>複雑</span>
                                        </label>
                                        <label class="radio-item">
                                            <input type="radio" name="middleComplexity" value="4">
                                            <span>非常に複雑</span>
                                        </label>
                                        <label class="radio-item">
                                            <input type="radio" name="middleComplexity" value="5">
                                            <span>極めて複雑</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="middleNotes">中盤のメモ:</label>
                                    <textarea id="middleNotes" name="middleNotes" rows="2" placeholder="中盤の味わいを記録"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div class="phase-item">
                            <h4>フィニッシュ（余韻）</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>長さ:</label>
                                    <div class="radio-grid">
                                        <label class="radio-item">
                                            <input type="radio" name="finishLength" value="1">
                                            <span>短い</span>
                                        </label>
                                        <label class="radio-item">
                                            <input type="radio" name="finishLength" value="2">
                                            <span>やや短い</span>
                                        </label>
                                        <label class="radio-item">
                                            <input type="radio" name="finishLength" value="3">
                                            <span>中程度</span>
                                        </label>
                                        <label class="radio-item">
                                            <input type="radio" name="finishLength" value="4">
                                            <span>やや長い</span>
                                        </label>
                                        <label class="radio-item">
                                            <input type="radio" name="finishLength" value="5">
                                            <span>非常に長い</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="finishNotes">フィニッシュのメモ:</label>
                                    <textarea id="finishNotes" name="finishNotes" rows="2" placeholder="余韻の印象を記録"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="notes">詳細メモ:</label>
                        <textarea id="notes" name="notes" rows="4" placeholder="味わい、印象、ペアリング推奨などを記録"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="foodPairing">フードペアリング:</label>
                        <input type="text" id="foodPairing" name="foodPairing" placeholder="ステーキ、チーズ、チョコレートなど">
                    </div>
                    
                    <div class="form-group">
                        <label for="occasion">飲用シーン:</label>
                        <input type="text" id="occasion" name="occasion" placeholder="誕生日、ディナー、パーティーなど">
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn primary-btn">詳細記録を保存</button>
                    <button type="button" class="btn outline-btn" onclick="hideUltraAdvancedForm()">キャンセル</button>
                </div>
            </form>
            </div>
        </div>

        <!-- ワイン一覧 -->
        <div class="wine-list" id="wineListSection" style="display: none;">
            <h2>記録されたワイン</h2>
            <div id="wineRecords">
                <p>ログインしてワインを記録しましょう</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (CDN) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut as firebaseSignOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, where, limit, doc, setDoc, updateDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase設定
        const firebaseConfig = {
            apiKey: "AIzaSyB6jnGUsdR9JDTZoDUq_QhM4Gr_gLVp3qA",
            authDomain: "mywinememory.firebaseapp.com",
            projectId: "mywinememory",
            storageBucket: "mywinememory.firebasestorage.app",
            messagingSenderId: "179280253269",
            appId: "1:179280253269:web:58330b5938412fafc21fdc",
            measurementId: "G-PP1B5425FD"
        };

        // Firebase初期化
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // グローバル変数
        let currentUser = null;
        let wineRecords = [];
        let userProfile = null;
        let authInitialized = false;


        // ローディング画面の制御
        function showLoadingOverlay(show, message = '') {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.style.display = 'flex';
                if (message) {
                    const subtext = overlay.querySelector('.loading-subtext');
                    subtext.textContent = message;
                }
            } else {
                overlay.style.display = 'none';
            }
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🍷 MyWineMemory - Ultra Advanced版を初期化中...');
            
            showLoadingOverlay(true, 'アプリケーションを準備中...');
            
            // 共有URLかどうかチェック
            const pathParts = window.location.pathname.split('/');
            if (pathParts[1] === 'shared' && pathParts[2]) {
                // 共有ページの場合
                loadSharedProfile(pathParts[2]);
            }
            
            // 最低3秒間はローディングを表示
            setTimeout(() => {
                showLoadingOverlay(false);
            }, 3000);

            initTheme();
            initMobileMenu();
            initStarRatings();
        });

        // 認証状態の監視
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            authInitialized = true; // 認証初期化完了
            
            if (user) {
                loadUserProfile();
                loadWineRecords();
                updateStats();
            }
            updateUI();
        });

        // UI更新
        function updateUI() {
            const loginNavView = document.getElementById('loginNavView');
            const userNavView = document.getElementById('userNavView');
            const userNavName = document.getElementById('userNavName');
            const userNavEmail = document.getElementById('userNavEmail');
            const wineFeaturesSection = document.getElementById('wineFeaturesSection');

            // 認証が初期化されていない場合は何もしない
            if (!authInitialized) {
                return;
            }

            if (currentUser) {
                // ログイン後のナビ表示
                loginNavView.classList.add('hidden');
                userNavView.classList.remove('hidden');
                
                // ユーザー情報を設定
                userNavName.textContent = currentUser.displayName || 'ユーザー';
                userNavEmail.textContent = currentUser.email || '';
                
                // 元のワイン機能コンテンツを復元
                restoreWineFeatures();
            } else {
                // ログイン前のナビ表示
                loginNavView.classList.remove('hidden');
                userNavView.classList.add('hidden');
                
                // ログイン促進メッセージを表示
                showLoginPrompt();
            }
        }

        // ワイン機能の復元
        function restoreWineFeatures() {
            const wineFeaturesSection = document.getElementById('wineFeaturesSection');
            
            // 元のコンテンツが既にある場合はそのまま表示
            if (!wineFeaturesSection.innerHTML.includes('login-required')) {
                wineFeaturesSection.style.display = 'block';
                return;
            }

            // 元のワイン機能コンテンツを復元
            wineFeaturesSection.innerHTML = `
                <div class="welcome-message">
                    <h2>🍷 ワインの世界へようこそ</h2>
                    <p>詳細な記録で、あなたのワイン体験をより豊かに</p>
                </div>
                
                <div class="quick-actions">
                    <button class="action-btn primary" onclick="showUltraAdvancedForm()">
                        <span class="btn-icon">📝</span>
                        <span class="btn-text">ワインを記録</span>
                    </button>
                    <a href="/quiz.html" class="action-btn secondary">
                        <span class="btn-icon">🧠</span>
                        <span class="btn-text">クイズに挑戦</span>
                    </a>
                    <a href="/analytics.html" class="action-btn tertiary">
                        <span class="btn-icon">📊</span>
                        <span class="btn-text">データ分析</span>
                    </a>
                </div>

                <div class="recent-wines" id="recentWines">
                    <h3>最近の記録</h3>
                    <div class="wine-grid" id="wineGrid">
                        <!-- ワイン記録がここに表示される -->
                    </div>
                </div>
            `;
            wineFeaturesSection.style.display = 'block';
        }

        // ログイン促進画面の表示
        function showLoginPrompt() {
            const wineFeaturesSection = document.getElementById('wineFeaturesSection');
            wineFeaturesSection.innerHTML = `
                <div class="login-required">
                    <h2>🍷 MyWineMemory</h2>
                    <p>ワインの記録を始めるには、ヘッダーからログインしてください</p>
                    <div class="login-features">
                        <div class="feature-preview">
                            <span class="preview-icon">📝</span>
                            <span>超詳細テイスティングノート</span>
                        </div>
                        <div class="feature-preview">
                            <span class="preview-icon">🧠</span>
                            <span>ワイン知識クイズ</span>
                        </div>
                        <div class="feature-preview">
                            <span class="preview-icon">📊</span>
                            <span>データ分析ダッシュボード</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ログアウト確認
        window.confirmSignOut = function() {
            if (confirm('ログアウトしますか？')) {
                signOut();
            }
        }

        // UUID生成
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // ユーザープロフィール読み込み
        async function loadUserProfile() {
            if (!currentUser) return;

            try {
                const userDocRef = doc(db, 'users', currentUser.uid);
                const userDoc = await getDoc(userDocRef);
                
                if (userDoc.exists()) {
                    userProfile = userDoc.data();
                } else {
                    // 初回ログイン時にユーザープロフィール作成
                    userProfile = {
                        displayName: currentUser.displayName,
                        email: currentUser.email,
                        photoURL: currentUser.photoURL,
                        isPublic: false,
                        shareToken: null,
                        createdAt: new Date()
                    };
                    await setDoc(userDocRef, userProfile);
                }
                
                // プライバシーボタンの状態を更新
                updatePrivacyButton();
            } catch (error) {
                console.error('ユーザープロフィールの読み込みに失敗:', error);
            }
        }

        // プライバシーボタンの状態更新
        function updatePrivacyButton() {
            const privacyText = document.getElementById('privacyText');
            const privacyToggle = document.getElementById('privacyToggle');
            
            if (userProfile && privacyText && privacyToggle) {
                if (userProfile.isPublic) {
                    privacyText.textContent = '公開';
                    privacyToggle.title = '記録を非公開にする';
                } else {
                    privacyText.textContent = '非公開';
                    privacyToggle.title = '記録を公開する';
                }
            }
        }

        // プライバシー切り替え
        window.togglePrivacy = async function() {
            if (!currentUser || !userProfile) {
                showStatus('ユーザー情報が読み込まれていません', 'error');
                return;
            }

            try {
                const userDocRef = doc(db, 'users', currentUser.uid);
                
                if (userProfile.isPublic) {
                    // 公開→非公開
                    await updateDoc(userDocRef, {
                        isPublic: false,
                        shareToken: null
                    });
                    userProfile.isPublic = false;
                    userProfile.shareToken = null;
                    
                    showStatus('記録を非公開にしました', 'success');
                } else {
                    // 非公開→公開
                    const shareToken = generateUUID();
                    await updateDoc(userDocRef, {
                        isPublic: true,
                        shareToken: shareToken
                    });
                    userProfile.isPublic = true;
                    userProfile.shareToken = shareToken;
                    
                    // 共有URLをクリップボードにコピー
                    const shareUrl = `${window.location.origin}/shared/${shareToken}`;
                    try {
                        await navigator.clipboard.writeText(shareUrl);
                        showCenterMessage('クリップボードに共有URLをコピーしました');
                    } catch (error) {
                        // フォールバック: テキストエリアを使用
                        const textarea = document.createElement('textarea');
                        textarea.value = shareUrl;
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textarea);
                        showCenterMessage('クリップボードに共有URLをコピーしました');
                    }
                    
                    showStatus('記録を公開しました', 'success');
                }
                
                updatePrivacyButton();
            } catch (error) {
                showStatus('設定の変更に失敗しました: ' + error.message, 'error');
            }
        }

        // 画面中央にメッセージ表示
        function showCenterMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'center-message';
            messageDiv.textContent = message;
            messageDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--primary-color);
                color: white;
                padding: 20px 30px;
                border-radius: 12px;
                font-size: 16px;
                font-weight: 500;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                z-index: 10000;
                animation: fadeInOut 3s ease-in-out;
            `;
            
            document.body.appendChild(messageDiv);
            
            // アニメーション追加
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeInOut {
                    0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                    20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                    80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                    100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                }
            `;
            document.head.appendChild(style);
            
            // 3秒後に削除
            setTimeout(() => {
                if (document.body.contains(messageDiv)) {
                    document.body.removeChild(messageDiv);
                }
                if (document.head.contains(style)) {
                    document.head.removeChild(style);
                }
            }, 3000);
        }

        // 共有プロフィール読み込み
        async function loadSharedProfile(shareToken) {
            try {
                // shareTokenでユーザーを検索
                const usersRef = collection(db, 'users');
                const q = query(usersRef, where('shareToken', '==', shareToken));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    showSharedError('共有URLが無効または期限切れです');
                    return;
                }
                
                const sharedUserDoc = querySnapshot.docs[0];
                const sharedUserData = sharedUserDoc.data();
                const sharedUserId = sharedUserDoc.id;
                
                if (!sharedUserData.isPublic) {
                    showSharedError('この記録は非公開に設定されています');
                    return;
                }
                
                // 共有ユーザーのワイン記録を読み込み
                await loadSharedWineRecords(sharedUserId, sharedUserData);
                
            } catch (error) {
                console.error('共有プロフィールの読み込みに失敗:', error);
                showSharedError('データの読み込みに失敗しました');
            }
        }

        // 共有ワイン記録読み込み
        async function loadSharedWineRecords(userId, userData) {
            try {
                const q = query(
                    collection(db, 'wine_records'),
                    where('userId', '==', userId),
                    orderBy('createdAt', 'desc'),
                    limit(20)
                );
                
                const querySnapshot = await getDocs(q);
                const sharedWines = [];
                
                querySnapshot.forEach((doc) => {
                    sharedWines.push(doc.data());
                });
                
                // 共有ページのUIを表示
                showSharedProfile(userData, sharedWines);
                
            } catch (error) {
                console.error('共有ワイン記録の読み込みに失敗:', error);
                showSharedError('ワイン記録の読み込みに失敗しました');
            }
        }

        // 共有プロフィール表示
        function showSharedProfile(userData, wineRecords) {
            const mainContainer = document.querySelector('.main-container');
            const totalWines = wineRecords.length;
            const avgRating = totalWines > 0 ? 
                (wineRecords.reduce((sum, wine) => sum + (wine.wineRating || 0), 0) / totalWines).toFixed(1) : 0;
            
            mainContainer.innerHTML = `
                <div class="shared-profile">
                    <div class="shared-header">
                        <div class="shared-user-info">
                            ${userData.photoURL ? `<img src="${userData.photoURL}" alt="${userData.displayName}" class="shared-avatar">` : ''}
                            <div class="shared-user-details">
                                <h1>🍷 ${userData.displayName || 'ワイン愛好家'}さんのワイン記録</h1>
                                <p>公開されたワインコレクションをご覧ください</p>
                            </div>
                        </div>
                        
                        <div class="shared-stats">
                            <div class="shared-stat">
                                <span class="stat-number">${totalWines}</span>
                                <span class="stat-label">記録数</span>
                            </div>
                            <div class="shared-stat">
                                <span class="stat-number">${avgRating}</span>
                                <span class="stat-label">平均評価</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="shared-wines">
                        <h2>ワイン記録</h2>
                        <div class="shared-wine-grid">
                            ${wineRecords.length > 0 ? wineRecords.map(wine => `
                                <div class="shared-wine-card">
                                    <h3>${wine.wineName}</h3>
                                    <p class="producer">${wine.producer}</p>
                                    ${wine.region ? `<p class="region">${wine.region}</p>` : ''}
                                    ${wine.vintage ? `<p class="vintage">${wine.vintage}年</p>` : ''}
                                    <div class="rating">${'⭐'.repeat(wine.wineRating || 0)} (${wine.wineRating}/5)</div>
                                    ${wine.notes ? `<p class="notes">${wine.notes}</p>` : ''}
                                    ${wine.foodPairing ? `<p class="pairing"><strong>ペアリング:</strong> ${wine.foodPairing}</p>` : ''}
                                </div>
                            `).join('') : '<p class="empty-shared">まだワインが記録されていません</p>'}
                        </div>
                    </div>
                    
                    <div class="shared-footer">
                        <a href="/" class="back-to-app">MyWineMemoryを始める</a>
                    </div>
                </div>
            `;
            
            // ナビバーを隠す
            document.querySelector('.main-navbar').style.display = 'none';
        }

        // 共有エラー表示
        function showSharedError(message) {
            const mainContainer = document.querySelector('.main-container');
            mainContainer.innerHTML = `
                <div class="shared-error">
                    <div class="error-content">
                        <h1>🚫 アクセスできません</h1>
                        <p>${message}</p>
                        <a href="/" class="back-to-app">MyWineMemoryに戻る</a>
                    </div>
                </div>
            `;
            
            // ナビバーを隠す
            document.querySelector('.main-navbar').style.display = 'none';
        }

        // Googleログイン
        window.signInWithGoogle = async function() {
            console.log('🔐 Google login attempt started');
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                console.log('✅ Google login successful');
                showStatus('ログインに成功しました', 'success');
            } catch (error) {
                console.error('❌ Google login failed:', error);
                showStatus('ログインに失敗しました: ' + error.message, 'error');
            }
        }

        // ログアウト
        window.signOut = async function() {
            try {
                await firebaseSignOut(auth);
                showStatus('ログアウトしました', 'success');
                document.getElementById('wineRecords').innerHTML = '<p>ログインしてワインを記録しましょう</p>';
                wineRecords = [];
                updateStats();
            } catch (error) {
                showStatus('ログアウトに失敗しました', 'error');
            }
        }


        // 超詳細フォーム表示
        window.showUltraAdvancedForm = function() {
            if (!currentUser) {
                showStatus('ヘッダーからログインしてください', 'error');
                return;
            }
            document.getElementById('ultraAdvancedForm').style.display = 'block';
        }

        // 超詳細フォーム非表示
        window.hideUltraAdvancedForm = function() {
            document.getElementById('ultraAdvancedForm').style.display = 'none';
            document.getElementById('ultraWineForm').reset();
            resetStarRatings();
        }

        // 超詳細ワイン記録保存
        window.saveUltraWineRecord = async function(event) {
            event.preventDefault();
            
            if (!currentUser) {
                showStatus('ログインが必要です', 'error');
                return;
            }

            const formData = new FormData(event.target);
            const wineData = {
                wineName: formData.get('wineName'),
                producer: formData.get('producer'),
                region: formData.get('region'),
                vintage: parseInt(formData.get('vintage')) || null,
                price: parseInt(formData.get('price')) || null,
                purchaseDate: formData.get('purchaseDate'),
                wineType: formData.get('wineType'),
                grapes: formData.get('grapes'),
                alcohol: parseFloat(formData.get('alcohol')) || null,
                colorTone: formData.get('colorTone'),
                colorIntensity: formData.get('colorIntensity'),
                clarity: formData.get('clarity'),
                aroma: formData.getAll('aroma'),
                sweetness: parseInt(formData.get('sweetness')),
                acidity: parseInt(formData.get('acidity')),
                tannin: parseInt(formData.get('tannin')),
                body: parseInt(formData.get('body')),
                finish: parseInt(formData.get('finish')),
                wineRating: parseInt(formData.get('wineRating')),
                // 味わい段階別分析
                attackIntensity: parseInt(formData.get('attackIntensity')) || null,
                attackNotes: formData.get('attackNotes'),
                middleComplexity: parseInt(formData.get('middleComplexity')) || null,
                middleNotes: formData.get('middleNotes'),
                finishLength: parseInt(formData.get('finishLength')) || null,
                finishNotes: formData.get('finishNotes'),
                // その他
                notes: formData.get('notes'),
                foodPairing: formData.get('foodPairing'),
                occasion: formData.get('occasion'),
                userId: currentUser.uid,
                createdAt: new Date()
            };

            try {
                await addDoc(collection(db, 'wine_records'), wineData);
                showStatus('詳細ワイン記録を保存しました！', 'success');
                hideUltraAdvancedForm();
                loadWineRecords();
                updateStats();
            } catch (error) {
                showStatus('保存に失敗しました: ' + error.message, 'error');
            }
        }

        // ワイン記録読み込み
        async function loadWineRecords() {
            if (!currentUser) return;

            try {
                const q = query(
                    collection(db, 'wine_records'),
                    where('userId', '==', currentUser.uid),
                    orderBy('createdAt', 'desc'),
                    limit(6)
                );
                
                const querySnapshot = await getDocs(q);
                const recentWinesContainer = document.getElementById('recentWines');
                
                if (querySnapshot.empty) {
                    recentWinesContainer.innerHTML = '<p class="empty-state">まだワインが記録されていません。最初のワインを記録しましょう！</p>';
                    return;
                }

                let html = '';
                wineRecords = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    wineRecords.push(data);
                    html += `
                        <div class="wine-card">
                            <h3>${data.wineName}</h3>
                            <p class="producer">${data.producer}</p>
                            ${data.region ? `<p class="region">${data.region}</p>` : ''}
                            <div class="rating">${'⭐'.repeat(data.wineRating || 0)}</div>
                            ${data.notes ? `<p class="notes">${data.notes.substring(0, 100)}...</p>` : ''}
                        </div>
                    `;
                });
                
                recentWinesContainer.innerHTML = html;
            } catch (error) {
                showStatus('データの読み込みに失敗しました: ' + error.message, 'error');
            }
        }

        // 統計情報更新
        function updateStats() {
            const totalWinesEl = document.getElementById('totalWines');
            const avgRatingEl = document.getElementById('avgRating');
            
            if (wineRecords.length > 0) {
                totalWinesEl.textContent = wineRecords.length;
                const avgRating = wineRecords.reduce((sum, wine) => sum + (wine.wineRating || 0), 0) / wineRecords.length;
                avgRatingEl.textContent = avgRating.toFixed(1);
            } else {
                totalWinesEl.textContent = '0';
                avgRatingEl.textContent = '0.0';
            }
        }


        // スター評価システム初期化
        function initStarRatings() {
            const starRatings = document.querySelectorAll('.star-rating');
            
            starRatings.forEach(rating => {
                const stars = rating.querySelectorAll('.star');
                const ratingName = rating.getAttribute('data-rating');
                const hiddenInput = document.querySelector(`input[name="${ratingName}"]`);
                
                stars.forEach(star => {
                    star.addEventListener('click', function() {
                        const value = this.getAttribute('data-value');
                        hiddenInput.value = value;
                        
                        stars.forEach((s, index) => {
                            if (index < value) {
                                s.classList.add('active');
                            } else {
                                s.classList.remove('active');
                            }
                        });
                    });
                });
            });
        }

        function resetStarRatings() {
            const stars = document.querySelectorAll('.star');
            const hiddenInputs = document.querySelectorAll('.star-rating + input[type="hidden"]');
            
            stars.forEach(star => star.classList.remove('active'));
            hiddenInputs.forEach(input => input.value = '0');
        }

        // テーマ切り替え機能
        function initTheme() {
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = document.querySelector('.theme-icon');
            
            const savedTheme = localStorage.getItem('theme') || 
                (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            
            setTheme(savedTheme);
            
            themeToggle.addEventListener('click', () => {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                setTheme(newTheme);
                localStorage.setItem('theme', newTheme);
            });
            
            function setTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                themeIcon.textContent = theme === 'dark' ? '☀️' : '🌙';
            }
        }

        // モバイルメニュー制御
        function initMobileMenu() {
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const navbarMenu = document.getElementById('navbarMenu');
            
            if (mobileMenuToggle && navbarMenu) {
                mobileMenuToggle.addEventListener('click', () => {
                    mobileMenuToggle.classList.toggle('active');
                    navbarMenu.classList.toggle('active');
                });
                
                const navLinks = navbarMenu.querySelectorAll('.nav-link');
                navLinks.forEach(link => {
                    link.addEventListener('click', () => {
                        mobileMenuToggle.classList.remove('active');
                        navbarMenu.classList.remove('active');
                    });
                });
                
                document.addEventListener('click', (e) => {
                    if (!mobileMenuToggle.contains(e.target) && !navbarMenu.contains(e.target)) {
                        mobileMenuToggle.classList.remove('active');
                        navbarMenu.classList.remove('active');
                    }
                });
            }
        }

        // ステータス表示（画面中央）
        function showStatus(message, type) {
            // 既存のメッセージを削除
            const existingMessage = document.querySelector('.center-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            // 新しいメッセージ要素を作成
            const messageEl = document.createElement('div');
            messageEl.className = `center-message ${type}`;
            messageEl.textContent = message;
            
            // bodyに追加
            document.body.appendChild(messageEl);
            
            // 3秒後に削除
            setTimeout(() => {
                if (messageEl.parentNode) {
                    messageEl.remove();
                }
            }, 3000);
        }

        console.log('🍷 MyWineMemory Ultra Advanced initialized successfully');
    </script>

    <!-- Service Worker登録 -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then((registration) => {
                    console.log('Service Worker registered');
                    
                    // 更新の確認
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('New Service Worker found, installing...');
                        
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed') {
                                if (navigator.serviceWorker.controller) {
                                    // 既存のSWがある場合、更新を通知
                                    console.log('New content available, showing update notification');
                                    showUpdateAvailable();
                                } else {
                                    // 初回インストールの場合
                                    console.log('Content cached for offline use');
                                }
                            }
                        });
                    });
                    
                    // 定期的に更新をチェック
                    setInterval(() => {
                        registration.update();
                    }, 60000); // 1分ごと
                })
                .catch(err => console.log('Service Worker registration failed:', err));
                
            // Service Workerからのメッセージを受信
            navigator.serviceWorker.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'SKIP_WAITING') {
                    window.location.reload();
                }
            });
        }

        function showUpdateAvailable() {
            const updateBanner = document.createElement('div');
            updateBanner.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: #4CAF50;
                color: white;
                padding: 10px;
                text-align: center;
                z-index: 10000;
                box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            `;
            updateBanner.innerHTML = `
                新しいバージョンが利用可能です！
                <button onclick="updateApp()" style="margin-left: 10px; padding: 5px 10px; background: white; color: #4CAF50; border: none; border-radius: 3px; cursor: pointer;">
                    更新
                </button>
                <button onclick="this.parentElement.remove()" style="margin-left: 5px; padding: 5px 10px; background: transparent; color: white; border: 1px solid white; border-radius: 3px; cursor: pointer;">
                    後で
                </button>
            `;
            document.body.appendChild(updateBanner);
        }

        window.updateApp = function() {
            // キャッシュをクリア
            if ('caches' in window) {
                caches.keys().then(cacheNames => {
                    return Promise.all(
                        cacheNames.map(cacheName => {
                            console.log('Deleting cache:', cacheName);
                            return caches.delete(cacheName);
                        })
                    );
                }).then(() => {
                    console.log('All caches cleared');
                    // Service Workerにskip waitingを指示
                    if (navigator.serviceWorker.controller) {
                        navigator.serviceWorker.controller.postMessage({ type: 'SKIP_WAITING' });
                    }
                    // 強制リロード
                    window.location.reload(true);
                });
            } else {
                // Service Workerにskip waitingを指示
                if (navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({ type: 'SKIP_WAITING' });
                }
                window.location.reload(true);
            }
        }
    </script>
</body>
</html>