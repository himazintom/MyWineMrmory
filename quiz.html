<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¯ã‚¤ãƒ³ã‚¯ã‚¤ã‚º - MyWineMemory</title>
    
    <!-- PWAè¨­å®š -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="WineMemory">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    
    <!-- é«˜åº¦ãªã‚¹ã‚¿ã‚¤ãƒ« -->
    <link rel="stylesheet" href="/advanced-style.css">
</head>
<body>
    <div class="container">
        <div class="header-with-theme">
            <div class="header-controls">
                <button class="back-btn" onclick="goHome()">â† ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
                <div class="theme-controls">
                    <button id="theme-toggle" class="theme-toggle" aria-label="ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ">
                        <span class="theme-icon">ğŸŒ™</span>
                    </button>
                </div>
            </div>
            <h1>ğŸ· ãƒ¯ã‚¤ãƒ³ã‚¯ã‚¤ã‚º</h1>
            <p>çŸ¥è­˜ã‚’æ·±ã‚ã¦ã€ãƒ¯ã‚¤ãƒ³ãƒã‚¹ã‚¿ãƒ¼ã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ï¼</p>
        </div>

        <!-- ã‚¯ã‚¤ã‚ºã‚¿ã‚¤ãƒ—é¸æŠ -->
        <div class="quiz-container" id="quizTypeSelection">
            <h2>ã‚¯ã‚¤ã‚ºã®ç¨®é¡ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
            <div class="quiz-types">
                <div class="quiz-type-card" onclick="startQuiz('general')">
                    <div class="quiz-type-icon">ğŸŒ</div>
                    <h3>ä¸€èˆ¬ãƒ¯ã‚¤ãƒ³çŸ¥è­˜</h3>
                    <p>ãƒ¯ã‚¤ãƒ³ã®åŸºæœ¬çŸ¥è­˜ã‹ã‚‰å°‚é–€çš„ãªå†…å®¹ã¾ã§</p>
                </div>
                
                <div class="quiz-type-card" onclick="startQuiz('personal')">
                    <div class="quiz-type-icon">ğŸ“š</div>
                    <h3>ãƒã‚¤ãƒ¯ã‚¤ãƒ³ã‚¯ã‚¤ã‚º</h3>
                    <p>ã‚ãªãŸãŒè¨˜éŒ²ã—ãŸãƒ¯ã‚¤ãƒ³ã‹ã‚‰å‡ºé¡Œ</p>
                </div>
                
                <div class="quiz-type-card" onclick="startQuiz('daily')">
                    <div class="quiz-type-icon">ğŸ“…</div>
                    <h3>ä»Šæ—¥ã®ã‚¯ã‚¤ã‚º</h3>
                    <p>æ¯æ—¥æ›´æ–°ã•ã‚Œã‚‹ç‰¹åˆ¥ãªã‚¯ã‚¤ã‚º</p>
                </div>
            </div>
        </div>

        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
        <div class="quiz-container loading hidden" id="loadingScreen">
            <div class="spinner"></div>
            <p>ã‚¯ã‚¤ã‚ºã‚’æº–å‚™ä¸­...</p>
        </div>

        <!-- ã‚¯ã‚¤ã‚ºç”»é¢ -->
        <div class="quiz-container hidden" id="quizContainer">
            <div class="quiz-header">
                <span id="questionNumber">å•é¡Œ 1/10</span>
                <div class="quiz-progress">
                    <div class="quiz-progress-bar" id="progressBar" style="width: 10%"></div>
                </div>
                <span id="quizScore">ã‚¹ã‚³ã‚¢: 0</span>
            </div>

            <div class="quiz-question" id="questionContainer">
                <!-- å•é¡ŒãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>

            <div id="feedbackContainer" class="quiz-feedback hidden">
                <!-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>

            <div class="quiz-actions">
                <button class="btn" id="nextBtn" onclick="nextQuestion()" disabled>æ¬¡ã®å•é¡Œ</button>
                <button class="btn" id="submitBtn" onclick="submitAnswer()" disabled>å›ç­”</button>
            </div>
        </div>

        <!-- çµæœç”»é¢ -->
        <div class="quiz-container quiz-results hidden" id="resultsContainer">
            <h2>ã‚¯ã‚¤ã‚ºå®Œäº†ï¼</h2>
            <div class="score-display" id="finalScore">8/10</div>
            <p id="scoreMessage">ç´ æ™´ã‚‰ã—ã„çµæœã§ã™ï¼</p>
            
            <div class="streak-info">
                <h3>ğŸ”¥ é€£ç¶šè¨˜éŒ²</h3>
                <p id="streakDisplay">7æ—¥é€£ç¶šã§ã‚¯ã‚¤ã‚ºã«æŒ‘æˆ¦ä¸­ï¼</p>
            </div>
            
            <div>
                <button class="btn" onclick="startNewQuiz()">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦</button>
                <button class="btn" onclick="goHome()">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (CDN) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyB6jnGUsdR9JDTZoDUq_QhM4Gr_gLVp3qA",
            authDomain: "mywinememory.firebaseapp.com",
            projectId: "mywinememory",
            storageBucket: "mywinememory.firebasestorage.app",
            messagingSenderId: "179280253269",
            appId: "1:179280253269:web:58330b5938412fafc21fdc",
            measurementId: "G-PP1B5425FD"
        };

        // FirebaseåˆæœŸåŒ–
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentUser = null;
        let currentQuiz = null;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let quizScore = 0;
        let quizType = '';

        // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (!user) {
                // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆã¯ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                window.location.href = '/';
            }
        });

        // ä¸€èˆ¬çš„ãªãƒ¯ã‚¤ãƒ³çŸ¥è­˜å•é¡Œãƒ‡ãƒ¼ã‚¿
        const generalQuestions = [
            {
                type: 'multiple_choice',
                question: 'ãƒ•ãƒ©ãƒ³ã‚¹ã®ãƒœãƒ«ãƒ‰ãƒ¼åœ°æ–¹ã§æœ€ã‚‚æœ‰åãªèµ¤ãƒ¯ã‚¤ãƒ³ç”¨ãƒ–ãƒ‰ã‚¦å“ç¨®ã¯ï¼Ÿ',
                options: ['ãƒ”ãƒãƒ»ãƒãƒ¯ãƒ¼ãƒ«', 'ã‚«ãƒ™ãƒ«ãƒãƒ»ã‚½ãƒ¼ãƒ´ã‚£ãƒ‹ãƒ¨ãƒ³', 'ã‚·ãƒ©ãƒ¼', 'ã‚µãƒ³ã‚¸ãƒ§ãƒ´ã‚§ãƒ¼ã‚¼'],
                correct: 1,
                explanation: 'ã‚«ãƒ™ãƒ«ãƒãƒ»ã‚½ãƒ¼ãƒ´ã‚£ãƒ‹ãƒ¨ãƒ³ã¯ãƒœãƒ«ãƒ‰ãƒ¼åœ°æ–¹ã®ä»£è¡¨çš„ãªå“ç¨®ã§ã€åŠ›å¼·ã„èµ¤ãƒ¯ã‚¤ãƒ³ã‚’ç”Ÿã¿å‡ºã—ã¾ã™ã€‚'
            },
            {
                type: 'true_false',
                question: 'ã‚·ãƒ£ãƒ³ãƒ‘ãƒ¼ãƒ‹ãƒ¥ã¯ã€ãƒ•ãƒ©ãƒ³ã‚¹ã®ã‚·ãƒ£ãƒ³ãƒ‘ãƒ¼ãƒ‹ãƒ¥åœ°æ–¹ã§ä½œã‚‰ã‚ŒãŸã‚¹ãƒ‘ãƒ¼ã‚¯ãƒªãƒ³ã‚°ãƒ¯ã‚¤ãƒ³ã®ã¿ã‚’æŒ‡ã™ã€‚',
                correct: true,
                explanation: 'ã‚·ãƒ£ãƒ³ãƒ‘ãƒ¼ãƒ‹ãƒ¥ã¯åŸç”£åœ°çµ±åˆ¶å‘¼ç§°ã§ã€ãƒ•ãƒ©ãƒ³ã‚¹ã®ã‚·ãƒ£ãƒ³ãƒ‘ãƒ¼ãƒ‹ãƒ¥åœ°æ–¹ã§ç‰¹å®šã®è£½æ³•ã§ä½œã‚‰ã‚ŒãŸã‚‚ã®ã®ã¿ãŒåä¹—ã‚Œã¾ã™ã€‚'
            },
            {
                type: 'multiple_choice',
                question: 'ãƒ¯ã‚¤ãƒ³ã®ã€Œã‚¿ãƒ³ãƒ‹ãƒ³ã€ã¨ã¯ä½•ã«ç”±æ¥ã™ã‚‹æˆåˆ†ã§ã™ã‹ï¼Ÿ',
                options: ['ãƒ–ãƒ‰ã‚¦ã®å®Ÿ', 'ãƒ–ãƒ‰ã‚¦ã®çš®ã‚„ç¨®', 'ç™ºé…µéç¨‹ã§ç”Ÿã¾ã‚Œã‚‹', 'æ¨½ã‹ã‚‰æŠ½å‡ºã•ã‚Œã‚‹'],
                correct: 1,
                explanation: 'ã‚¿ãƒ³ãƒ‹ãƒ³ã¯ä¸»ã«ãƒ–ãƒ‰ã‚¦ã®çš®ã‚„ç¨®ã€èŒã‹ã‚‰æŠ½å‡ºã•ã‚Œã‚‹æ¸‹ã¿æˆåˆ†ã§ã™ã€‚æ¨½ã‹ã‚‰ã‚‚æŠ½å‡ºã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚'
            },
            {
                type: 'free_input',
                question: 'ã‚¤ã‚¿ãƒªã‚¢ã®ãƒˆã‚¹ã‚«ãƒ¼ãƒŠå·ã§ç”Ÿç”£ã•ã‚Œã‚‹ã€ã‚µãƒ³ã‚¸ãƒ§ãƒ´ã‚§ãƒ¼ã‚¼ã‚’ä¸»ä½“ã¨ã—ãŸæœ‰åãªèµ¤ãƒ¯ã‚¤ãƒ³ã®åå‰ã‚’ç­”ãˆã¦ãã ã•ã„ã€‚',
                keywords: ['ã‚­ãƒ£ãƒ³ãƒ†ã‚£', 'chianti'],
                explanation: 'ã‚­ãƒ£ãƒ³ãƒ†ã‚£ã¯ã€ãƒˆã‚¹ã‚«ãƒ¼ãƒŠå·ã®ã‚­ãƒ£ãƒ³ãƒ†ã‚£åœ°åŒºã§ç”Ÿç”£ã•ã‚Œã‚‹ã€ã‚µãƒ³ã‚¸ãƒ§ãƒ´ã‚§ãƒ¼ã‚¼ã‚’ä¸»ä½“ã¨ã—ãŸèµ¤ãƒ¯ã‚¤ãƒ³ã§ã™ã€‚'
            },
            {
                type: 'multiple_choice',
                question: 'ãƒ¯ã‚¤ãƒ³ã®é©åˆ‡ãªä¿å­˜æ¸©åº¦ã¯ä¸€èˆ¬çš„ã«ä½•åº¦ç¨‹åº¦ã§ã™ã‹ï¼Ÿ',
                options: ['5-8â„ƒ', '12-15â„ƒ', '18-20â„ƒ', '25-28â„ƒ'],
                correct: 1,
                explanation: '12-15â„ƒãŒãƒ¯ã‚¤ãƒ³ã®é•·æœŸä¿å­˜ã«æœ€ã‚‚é©ã—ãŸæ¸©åº¦ã§ã™ã€‚æ¸©åº¦ãŒé«˜ã™ãã‚‹ã¨åŠ£åŒ–ãŒé€²ã¿ã€ä½ã™ãã‚‹ã¨å‘³ã‚ã„ãŒé–‰ã˜ã¦ã—ã¾ã„ã¾ã™ã€‚'
            }
        ];

        // ã‚¯ã‚¤ã‚ºé–‹å§‹
        window.startQuiz = async function(type) {
            quizType = type;
            currentQuestionIndex = 0;
            userAnswers = [];
            quizScore = 0;

            document.getElementById('quizTypeSelection').classList.add('hidden');
            document.getElementById('loadingScreen').classList.remove('hidden');

            try {
                if (type === 'personal') {
                    currentQuiz = await generatePersonalQuiz();
                } else if (type === 'daily') {
                    currentQuiz = await generateDailyQuiz();
                } else {
                    currentQuiz = generateGeneralQuiz();
                }

                setTimeout(() => {
                    document.getElementById('loadingScreen').classList.add('hidden');
                    document.getElementById('quizContainer').classList.remove('hidden');
                    showQuestion();
                }, 1500);

            } catch (error) {
                console.error('ã‚¯ã‚¤ã‚ºç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚¯ã‚¤ã‚ºã®æº–å‚™ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                resetQuiz();
            }
        }

        // ä¸€èˆ¬ã‚¯ã‚¤ã‚ºç”Ÿæˆ
        function generateGeneralQuiz() {
            return {
                title: 'ä¸€èˆ¬ãƒ¯ã‚¤ãƒ³çŸ¥è­˜ã‚¯ã‚¤ã‚º',
                questions: [...generalQuestions].sort(() => Math.random() - 0.5).slice(0, 5)
            };
        }

        // å€‹äººã‚¯ã‚¤ã‚ºç”Ÿæˆ
        async function generatePersonalQuiz() {
            if (!currentUser) throw new Error('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');

            const q = query(
                collection(db, 'wine_records'),
                where('userId', '==', currentUser.uid),
                orderBy('createdAt', 'desc'),
                limit(10)
            );

            const snapshot = await getDocs(q);
            const wines = [];
            snapshot.forEach(doc => wines.push(doc.data()));

            if (wines.length < 3) {
                throw new Error('ã‚¯ã‚¤ã‚ºç”Ÿæˆã«ã¯æœ€ä½3æœ¬ã®ãƒ¯ã‚¤ãƒ³è¨˜éŒ²ãŒå¿…è¦ã§ã™');
            }

            const questions = wines.slice(0, 5).map(wine => ({
                type: 'multiple_choice',
                question: `${wine.wineName}ã«ã¤ã„ã¦ã€ã‚ãªãŸã¯ã©ã‚“ãªè©•ä¾¡ã‚’ã¤ã‘ã¾ã—ãŸã‹ï¼Ÿ`,
                wineInfo: {
                    name: wine.wineName,
                    producer: wine.producer,
                    vintage: wine.vintage,
                    notes: wine.notes
                },
                options: ['1ç‚¹', '2ç‚¹', '3ç‚¹', '4ç‚¹', '5ç‚¹'],
                correct: wine.wineRating - 1,
                explanation: `ã‚ãªãŸã¯${wine.wineName}ã«${wine.wineRating}ç‚¹ã‚’ã¤ã‘ã¾ã—ãŸã€‚${wine.notes ? `ãƒ¡ãƒ¢: ${wine.notes}` : ''}`
            }));

            return {
                title: 'ãƒã‚¤ãƒ¯ã‚¤ãƒ³ã‚¯ã‚¤ã‚º',
                questions: questions
            };
        }

        // ä»Šæ—¥ã®ã‚¯ã‚¤ã‚ºç”Ÿæˆ
        async function generateDailyQuiz() {
            // æ—¥ä»˜ã‚’ã‚·ãƒ¼ãƒ‰ã¨ã—ã¦ãƒ©ãƒ³ãƒ€ãƒ å•é¡Œã‚’é¸æŠ
            const today = new Date().toDateString();
            const seed = today.split('').reduce((a, b) => a + b.charCodeAt(0), 0);
            
            const shuffled = [...generalQuestions];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = (seed + i) % (i + 1);
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }

            return {
                title: 'ä»Šæ—¥ã®ãƒ¯ã‚¤ãƒ³ã‚¯ã‚¤ã‚º',
                questions: shuffled.slice(0, 3)
            };
        }

        // å•é¡Œè¡¨ç¤º
        function showQuestion() {
            if (currentQuestionIndex >= currentQuiz.questions.length) {
                showResults();
                return;
            }

            const question = currentQuiz.questions[currentQuestionIndex];
            const questionContainer = document.getElementById('questionContainer');
            
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
            const progress = ((currentQuestionIndex + 1) / currentQuiz.questions.length) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('questionNumber').textContent = 
                `å•é¡Œ ${currentQuestionIndex + 1}/${currentQuiz.questions.length}`;
            document.getElementById('quizScore').textContent = `ã‚¹ã‚³ã‚¢: ${quizScore}`;

            // å•é¡ŒHTMLç”Ÿæˆ
            let questionHTML = '';
            
            // ãƒ¯ã‚¤ãƒ³æƒ…å ±ãŒã‚ã‚Œã°è¡¨ç¤º
            if (question.wineInfo) {
                questionHTML += `
                    <div class="wine-info">
                        <h3>${question.wineInfo.name}</h3>
                        <p><strong>ç”Ÿç”£è€…:</strong> ${question.wineInfo.producer}</p>
                        ${question.wineInfo.vintage ? `<p><strong>ãƒ´ã‚£ãƒ³ãƒ†ãƒ¼ã‚¸:</strong> ${question.wineInfo.vintage}</p>` : ''}
                        ${question.wineInfo.notes ? `<p><strong>ã‚ãªãŸã®ãƒ¡ãƒ¢:</strong> ${question.wineInfo.notes}</p>` : ''}
                    </div>
                `;
            }

            questionHTML += `<div class="question-text">${question.question}</div>`;

            if (question.type === 'multiple_choice') {
                questionHTML += '<div class="answer-options">';
                question.options.forEach((option, index) => {
                    questionHTML += `
                        <div class="answer-option" onclick="selectAnswer(${index})">
                            ${option}
                        </div>
                    `;
                });
                questionHTML += '</div>';
            } else if (question.type === 'true_false') {
                questionHTML += `
                    <div class="answer-options">
                        <div class="answer-option" onclick="selectAnswer(true)">æ­£ã—ã„</div>
                        <div class="answer-option" onclick="selectAnswer(false)">é–“é•ã„</div>
                    </div>
                `;
            } else if (question.type === 'free_input') {
                questionHTML += `
                    <textarea class="text-input" id="freeAnswer" placeholder="ã‚ãªãŸã®ç­”ãˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
                `;
            }

            questionContainer.innerHTML = questionHTML;
            
            // ãƒœã‚¿ãƒ³çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('nextBtn').disabled = true;
            document.getElementById('feedbackContainer').classList.add('hidden');
        }

        // ç­”ãˆé¸æŠ
        window.selectAnswer = function(answer) {
            // å‰ã®é¸æŠã‚’ã‚¯ãƒªã‚¢
            document.querySelectorAll('.answer-option').forEach(opt => {
                opt.classList.remove('selected');
            });

            // æ–°ã—ã„é¸æŠã‚’ãƒãƒ¼ã‚¯
            if (typeof answer === 'number') {
                document.querySelectorAll('.answer-option')[answer].classList.add('selected');
            } else {
                const options = document.querySelectorAll('.answer-option');
                if (answer === true) options[0].classList.add('selected');
                else options[1].classList.add('selected');
            }

            userAnswers[currentQuestionIndex] = answer;
            document.getElementById('submitBtn').disabled = false;
        }

        // å›ç­”æå‡º
        window.submitAnswer = async function() {
            const question = currentQuiz.questions[currentQuestionIndex];
            let userAnswer = userAnswers[currentQuestionIndex];
            
            // è‡ªç”±å…¥åŠ›ã®å ´åˆ
            if (question.type === 'free_input') {
                userAnswer = document.getElementById('freeAnswer').value.trim();
                userAnswers[currentQuestionIndex] = userAnswer;
            }

            // ç­”ãˆã‚’ãƒã‚§ãƒƒã‚¯
            let isCorrect = false;
            if (question.type === 'multiple_choice') {
                isCorrect = userAnswer === question.correct;
            } else if (question.type === 'true_false') {
                isCorrect = userAnswer === question.correct;
            } else if (question.type === 'free_input') {
                // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒãƒ³ã‚°ã§åˆ¤å®š
                const keywords = question.keywords || [];
                isCorrect = keywords.some(keyword => 
                    userAnswer.toLowerCase().includes(keyword.toLowerCase())
                );
            }

            if (isCorrect) {
                quizScore++;
            }

            // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º
            showFeedback(isCorrect, question);
            
            // ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('nextBtn').disabled = false;
        }

        // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º
        function showFeedback(isCorrect, question) {
            const feedbackContainer = document.getElementById('feedbackContainer');
            feedbackContainer.className = `quiz-feedback ${isCorrect ? 'correct' : 'incorrect'}`;
            
            let feedbackHTML = `
                <h4>${isCorrect ? 'âœ… æ­£è§£ï¼' : 'âŒ ä¸æ­£è§£'}</h4>
                <p>${question.explanation}</p>
            `;

            // é¸æŠè‚¢ã®æ­£è§£ã‚’è¡¨ç¤º
            if (question.type === 'multiple_choice') {
                document.querySelectorAll('.answer-option').forEach((opt, index) => {
                    if (index === question.correct) {
                        opt.classList.add('correct');
                    } else if (opt.classList.contains('selected')) {
                        opt.classList.add('incorrect');
                    }
                });
            }

            feedbackContainer.innerHTML = feedbackHTML;
            feedbackContainer.classList.remove('hidden');
        }

        // æ¬¡ã®å•é¡Œ
        window.nextQuestion = function() {
            currentQuestionIndex++;
            showQuestion();
        }

        // çµæœè¡¨ç¤º
        function showResults() {
            document.getElementById('quizContainer').classList.add('hidden');
            document.getElementById('resultsContainer').classList.remove('hidden');

            const totalQuestions = currentQuiz.questions.length;
            const scorePercentage = Math.round((quizScore / totalQuestions) * 100);

            document.getElementById('finalScore').textContent = `${quizScore}/${totalQuestions}`;
            
            let message = '';
            if (scorePercentage >= 90) message = 'å®Œç’§ã§ã™ï¼ãƒ¯ã‚¤ãƒ³ãƒã‚¹ã‚¿ãƒ¼ãƒ¬ãƒ™ãƒ«ã§ã™ï¼';
            else if (scorePercentage >= 70) message = 'ç´ æ™´ã‚‰ã—ã„çµæœã§ã™ï¼';
            else if (scorePercentage >= 50) message = 'è‰¯ã„æˆç¸¾ã§ã™ã€‚ã•ã‚‰ã«å­¦ç¿’ã‚’ç¶šã‘ã¾ã—ã‚‡ã†ï¼';
            else message = 'é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼ç¶™ç¶šãŒå¤§åˆ‡ã§ã™ã€‚';

            document.getElementById('scoreMessage').textContent = message;

            // çµæœã‚’Firestoreã«ä¿å­˜
            saveQuizResult();
        }

        // ã‚¯ã‚¤ã‚ºçµæœä¿å­˜
        async function saveQuizResult() {
            if (!currentUser) return;

            try {
                await addDoc(collection(db, 'quiz_results'), {
                    userId: currentUser.uid,
                    quizType: quizType,
                    score: quizScore,
                    totalQuestions: currentQuiz.questions.length,
                    percentage: Math.round((quizScore / currentQuiz.questions.length) * 100),
                    answers: userAnswers,
                    completedAt: new Date()
                });

                console.log('ã‚¯ã‚¤ã‚ºçµæœãŒä¿å­˜ã•ã‚Œã¾ã—ãŸ');
            } catch (error) {
                console.error('çµæœä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // æ–°ã—ã„ã‚¯ã‚¤ã‚ºé–‹å§‹
        window.startNewQuiz = function() {
            resetQuiz();
        }

        // ã‚¯ã‚¤ã‚ºãƒªã‚»ãƒƒãƒˆ
        function resetQuiz() {
            document.getElementById('resultsContainer').classList.add('hidden');
            document.getElementById('quizContainer').classList.add('hidden');
            document.getElementById('quizTypeSelection').classList.remove('hidden');
        }

        // ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
        window.goHome = function() {
            window.location.href = '/';
        }

        // ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
        function initTheme() {
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = document.querySelector('.theme-icon');
            
            if (!themeToggle || !themeIcon) return;
            
            // ä¿å­˜ã•ã‚ŒãŸãƒ†ãƒ¼ãƒã¾ãŸã¯ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚’èª­ã¿è¾¼ã¿
            const savedTheme = localStorage.getItem('theme') || 
                (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            
            setTheme(savedTheme);
            
            themeToggle.addEventListener('click', () => {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                setTheme(newTheme);
                localStorage.setItem('theme', newTheme);
            });
            
            function setTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                themeIcon.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
            }
        }

        // ãƒ†ãƒ¼ãƒåˆæœŸåŒ–
        initTheme();

        console.log('ğŸ· Quiz system initialized');
    </script>

    <!-- Service Workerç™»éŒ² -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then(() => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed'));
        }
    </script>
</body>
</html>