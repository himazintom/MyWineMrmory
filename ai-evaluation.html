<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIåˆ†æ - MyWineMemory</title>
    
    <!-- PWAè¨­å®š -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="WineMemory">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    
    <!-- é«˜åº¦ãªã‚¹ã‚¿ã‚¤ãƒ« -->
    <link rel="stylesheet" href="/advanced-style.css">
    
    <style>
        .ai-analysis-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .ai-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }
        
        .ai-input-section {
            margin-bottom: 30px;
        }
        
        .tasting-input {
            width: 100%;
            min-height: 120px;
            padding: 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text-color);
            font-size: 16px;
            resize: vertical;
            transition: border-color 0.3s ease;
        }
        
        .tasting-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .analyze-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 16px;
        }
        
        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        
        .analyze-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .analysis-result {
            margin-top: 24px;
            padding: 20px;
            background: var(--secondary-bg);
            border-radius: 8px;
            border-left: 4px solid var(--accent-color);
        }
        
        .analysis-section {
            margin-bottom: 20px;
        }
        
        .analysis-section h4 {
            color: var(--primary-color);
            margin-bottom: 8px;
            font-size: 18px;
        }
        
        .analysis-content {
            line-height: 1.6;
            color: var(--text-color);
        }
        
        .confidence-bar {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981);
            transition: width 0.5s ease;
        }
        
        .wine-recommendations {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }
        
        .recommendation-card {
            background: var(--card-bg);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .recommendation-card h5 {
            color: var(--primary-color);
            margin-bottom: 8px;
        }
        
        .improvement-tips {
            background: var(--info-bg);
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }
        
        .improvement-tips h4 {
            color: var(--info-color);
            margin-bottom: 12px;
        }
        
        .tip-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .tip-icon {
            color: var(--success-color);
            margin-top: 2px;
        }
        
        .error-message {
            background: var(--error-bg);
            color: var(--error-color);
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }
        
        .sample-notes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }
        
        .sample-note {
            padding: 12px;
            background: var(--secondary-bg);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        
        .sample-note:hover {
            border-color: var(--primary-color);
            background: var(--card-bg);
        }
        
        .sample-note-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 4px;
        }
        
        .sample-note-text {
            font-size: 14px;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <!-- Professional Navigation Header -->
    <nav class="main-navbar">
        <div class="navbar-container">
            <div class="navbar-brand">
                <span class="brand-icon">ğŸ·</span>
                <span class="brand-text">MyWineMemory</span>
            </div>
            
            <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã">
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
            </button>
            
            <div class="navbar-menu" id="navbarMenu">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a href="/" class="nav-link">
                            <span class="nav-icon">ğŸ </span>
                            <span class="nav-text">ãƒ›ãƒ¼ãƒ </span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/quiz.html" class="nav-link">
                            <span class="nav-icon">ğŸ§ </span>
                            <span class="nav-text">ã‚¯ã‚¤ã‚º</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/analytics.html" class="nav-link">
                            <span class="nav-icon">ğŸ“Š</span>
                            <span class="nav-text">åˆ†æ</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/ai-evaluation.html" class="nav-link active">
                            <span class="nav-icon">ğŸ¤–</span>
                            <span class="nav-text">AIåˆ†æ</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/learning-progress.html" class="nav-link">
                            <span class="nav-icon">ğŸ“ˆ</span>
                            <span class="nav-text">å­¦ç¿’é€²æ—</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/skill-tree.html" class="nav-link">
                            <span class="nav-icon">ğŸŒ³</span>
                            <span class="nav-text">ã‚¹ã‚­ãƒ«ãƒ„ãƒªãƒ¼</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <button id="theme-toggle" class="theme-toggle nav-link nav-button" aria-label="ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ">
                            <span class="theme-icon">ğŸŒ™</span>
                            <span class="nav-text">ãƒ†ãƒ¼ãƒ</span>
                        </button>
                    </li>
                    <li class="nav-item auth-nav" id="authNavItem">
                        <!-- ãƒ­ã‚°ã‚¤ãƒ³å‰è¡¨ç¤º -->
                        <div id="loginNavView" class="auth-nav-content">
                            <button class="nav-link nav-button auth-button" onclick="signInWithGoogle()">
                                <span class="nav-icon">ğŸ‘¤</span>
                                <span class="nav-text">ãƒ­ã‚°ã‚¤ãƒ³</span>
                            </button>
                        </div>
                        
                        <!-- ãƒ­ã‚°ã‚¤ãƒ³å¾Œè¡¨ç¤º -->
                        <div id="userNavView" class="auth-nav-content hidden">
                            <div class="user-nav-info">
                                <img id="userAvatar" class="user-avatar" src="" alt="ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ãƒã‚¿ãƒ¼" style="display: none;">
                                <div class="user-details">
                                    <span class="user-name" id="userNavName">ãƒ¦ãƒ¼ã‚¶ãƒ¼</span>
                                    <span class="user-email" id="userNavEmail"></span>
                                </div>
                                <button id="privacyToggle" class="privacy-toggle-btn" onclick="togglePrivacy()" title="è¨˜éŒ²ã®å…¬é–‹/éå…¬é–‹ã‚’åˆ‡ã‚Šæ›¿ãˆ">
                                    <span id="privacyIcon">ğŸ”’</span>
                                </button>
                                <button class="logout-btn" onclick="confirmSignOut()" title="ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ">
                                    <span>ğŸšª</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
                        <div id="authNavStatus" class="auth-status hidden"></div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="main-container">
        <div class="ai-analysis-container">
            <div class="ai-card">
                <h1>ğŸ¤– AI ãƒ†ã‚¤ã‚¹ãƒ†ã‚£ãƒ³ã‚°åˆ†æ</h1>
                <p>ã‚ãªãŸã®ãƒ†ã‚¤ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒãƒ¼ãƒˆã‚’AIãŒåˆ†æã—ã€å°‚é–€çš„ãªè©•ä¾¡ã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¾ã™</p>
            </div>
            
            <!-- ãƒ­ã‚°ã‚¤ãƒ³å¿…è¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <div id="loginRequired" class="ai-card" style="text-align: center;">
                <h2>ğŸ” ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</h2>
                <p>AIåˆ†ææ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ã€ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
                <button class="btn primary-btn" onclick="signInWithGoogle()">
                    <span class="btn-icon">G</span>
                    Googleã§ãƒ­ã‚°ã‚¤ãƒ³
                </button>
            </div>
            
            <!-- AIåˆ†æã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div id="aiAnalysisContent" class="hidden">
                <!-- ã‚µãƒ³ãƒ—ãƒ«ãƒãƒ¼ãƒˆ -->
                <div class="ai-card">
                    <h3>ğŸ“ ã‚µãƒ³ãƒ—ãƒ«ãƒ†ã‚¤ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒãƒ¼ãƒˆ</h3>
                    <p>ä»¥ä¸‹ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è©¦ã—ã¦ã¿ã¦ãã ã•ã„ï¼š</p>
                    <div class="sample-notes">
                        <div class="sample-note" onclick="loadSampleNote(0)">
                            <div class="sample-note-title">åˆå¿ƒè€…ãƒ¬ãƒ™ãƒ«</div>
                            <div class="sample-note-text">ç¾å‘³ã—ã„èµ¤ãƒ¯ã‚¤ãƒ³ã€‚å°‘ã—é…¸ã£ã±ã„ã‘ã©é£²ã¿ã‚„ã™ã„ã€‚</div>
                        </div>
                        <div class="sample-note" onclick="loadSampleNote(1)">
                            <div class="sample-note-title">ä¸­ç´šãƒ¬ãƒ™ãƒ«</div>
                            <div class="sample-note-text">æ·±ã„ãƒ«ãƒ“ãƒ¼è‰²ã€‚ãƒ–ãƒ©ãƒƒã‚¯ãƒ™ãƒªãƒ¼ã®é¦™ã‚ŠãŒå¼·ãã€ã‚¿ãƒ³ãƒ‹ãƒ³ãŒã—ã£ã‹ã‚Šã—ã¦ã„ã‚‹ã€‚</div>
                        </div>
                        <div class="sample-note" onclick="loadSampleNote(2)">
                            <div class="sample-note-title">ä¸Šç´šãƒ¬ãƒ™ãƒ«</div>
                            <div class="sample-note-text">æ¿ƒã„ã‚¬ãƒ¼ãƒãƒƒãƒˆè‰²ã€ã‚¨ãƒƒã‚¸ã¯åƒ…ã‹ã«ã‚ªãƒ¬ãƒ³ã‚¸ãŒã‹ã£ã¦ã„ã‚‹ã€‚ç¬¬ä¸€ã‚¢ãƒ­ãƒã¯ã‚«ã‚·ã‚¹ã¨ãƒ–ãƒ©ãƒƒã‚¯ãƒ™ãƒªãƒ¼ã€ç¬¬äºŒã‚¢ãƒ­ãƒã§ãƒãƒ‹ãƒ©ã¨ã‚¹ãƒ‘ã‚¤ã‚¹ã®ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ã€‚</div>
                        </div>
                    </div>
                </div>
                
                <!-- ãƒ†ã‚¤ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒãƒ¼ãƒˆå…¥åŠ› -->
                <div class="ai-card">
                    <div class="ai-input-section">
                        <h3>ğŸ· ãƒ†ã‚¤ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒãƒ¼ãƒˆã‚’å…¥åŠ›</h3>
                        <textarea 
                            id="tastingNote" 
                            class="tasting-input"
                            placeholder="ãƒ¯ã‚¤ãƒ³ã®å¤–è¦³ã€é¦™ã‚Šã€å‘³ã‚ã„ã€ãƒ•ã‚£ãƒ‹ãƒƒã‚·ãƒ¥ã«ã¤ã„ã¦è‡ªç”±ã«è¨˜è¿°ã—ã¦ãã ã•ã„&#10;&#10;ä¾‹ï¼š&#10;ãƒ»å¤–è¦³ï¼šæ·±ã„ãƒ«ãƒ“ãƒ¼è‰²ã€é€æ˜åº¦ã¯é«˜ã„&#10;ãƒ»é¦™ã‚Šï¼šãƒ–ãƒ©ãƒƒã‚¯ãƒ™ãƒªãƒ¼ã€ã‚«ã‚·ã‚¹ã®æœå®Ÿé¦™ã«ã€ãƒãƒ‹ãƒ©ã‚„ã‚¹ãƒ‘ã‚¤ã‚¹ã®ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹&#10;ãƒ»å‘³ã‚ã„ï¼šè±Šã‹ãªæœå®Ÿå‘³ã€ã—ã£ã‹ã‚Šã—ãŸã‚¿ãƒ³ãƒ‹ãƒ³ã€é©åº¦ãªé…¸å‘³&#10;ãƒ»ãƒ•ã‚£ãƒ‹ãƒƒã‚·ãƒ¥ï¼šé•·ãã€ä½™éŸ»ã«å¿ƒåœ°ã‚ˆã„ã‚¹ãƒ‘ã‚¤ã‚¹æ„Ÿ"
                        ></textarea>
                        <button id="analyzeBtn" class="analyze-btn" onclick="analyzeWine()">
                            <span id="analyzeIcon">ğŸ¤–</span>
                            <span id="analyzeText">AIåˆ†æã‚’é–‹å§‹</span>
                        </button>
                    </div>
                </div>
                
                <!-- åˆ†æçµæœ -->
                <div id="analysisResults" class="ai-card hidden">
                    <h3>ğŸ“Š AIåˆ†æçµæœ</h3>
                    <div id="analysisContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK ã¨ JavaScript -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut as firebaseSignOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyB6jnGUsdR9JDTZoDUq_QhM4Gr_gLVp3qA",
            authDomain: "mywinememory.firebaseapp.com",
            projectId: "mywinememory",
            storageBucket: "mywinememory.firebasestorage.app",
            messagingSenderId: "179280253269",
            appId: "1:179280253269:web:58330b5938412fafc21fdc",
            measurementId: "G-PP1B5425FD"
        };

        // FirebaseåˆæœŸåŒ–
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentUser = null;

        // ã‚µãƒ³ãƒ—ãƒ«ãƒãƒ¼ãƒˆ
        const sampleNotes = [
            "ç¾å‘³ã—ã„èµ¤ãƒ¯ã‚¤ãƒ³ã€‚å°‘ã—é…¸ã£ã±ã„ã‘ã©é£²ã¿ã‚„ã™ã„ã€‚ãƒ•ãƒ«ãƒ¼ãƒ„ã®å‘³ãŒã™ã‚‹ã€‚",
            "æ·±ã„ãƒ«ãƒ“ãƒ¼è‰²ã€‚ãƒ–ãƒ©ãƒƒã‚¯ãƒ™ãƒªãƒ¼ã®é¦™ã‚ŠãŒå¼·ãã€ã‚¿ãƒ³ãƒ‹ãƒ³ãŒã—ã£ã‹ã‚Šã—ã¦ã„ã‚‹ã€‚é…¸å‘³ã¨ã®ãƒãƒ©ãƒ³ã‚¹ãŒè‰¯ã„ã€‚",
            "æ¿ƒã„ã‚¬ãƒ¼ãƒãƒƒãƒˆè‰²ã€ã‚¨ãƒƒã‚¸ã¯åƒ…ã‹ã«ã‚ªãƒ¬ãƒ³ã‚¸ãŒã‹ã£ã¦ã„ã‚‹ã€‚ç¬¬ä¸€ã‚¢ãƒ­ãƒã¯ã‚«ã‚·ã‚¹ã¨ãƒ–ãƒ©ãƒƒã‚¯ãƒ™ãƒªãƒ¼ã€ç¬¬äºŒã‚¢ãƒ­ãƒã§ãƒãƒ‹ãƒ©ã¨ã‚¹ãƒ‘ã‚¤ã‚¹ã®ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ã€‚å£å½“ãŸã‚Šã¯æ»‘ã‚‰ã‹ã§ã€å‡ç¸®ã—ãŸæœå®Ÿå‘³ã¨ã‚·ãƒ«ã‚­ãƒ¼ãªã‚¿ãƒ³ãƒ‹ãƒ³ãŒèª¿å’Œã—ã¦ã„ã‚‹ã€‚ãƒ•ã‚£ãƒ‹ãƒƒã‚·ãƒ¥ã¯é•·ãã€ä½™éŸ»ã«ãƒ€ãƒ¼ã‚¯ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆã¨ã‚³ãƒ¼ãƒ’ãƒ¼ã®é¦™ã‚ŠãŒæ®‹ã‚‹ã€‚"
        ];

        // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            updateUI();
        });

        // UIæ›´æ–°
        function updateUI() {
            const loginNavView = document.getElementById('loginNavView');
            const userNavView = document.getElementById('userNavView');
            const userNavName = document.getElementById('userNavName');
            const userNavEmail = document.getElementById('userNavEmail');
            const userAvatar = document.getElementById('userAvatar');
            const loginRequired = document.getElementById('loginRequired');
            const aiAnalysisContent = document.getElementById('aiAnalysisContent');

            if (currentUser) {
                // ãƒ­ã‚°ã‚¤ãƒ³å¾Œã®ãƒŠãƒ“è¡¨ç¤º
                loginNavView.classList.add('hidden');
                userNavView.classList.remove('hidden');
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¨­å®š
                userNavName.textContent = currentUser.displayName || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
                userNavEmail.textContent = currentUser.email || '';
                
                // ã‚¢ãƒã‚¿ãƒ¼ç”»åƒãŒã‚ã‚Œã°è¡¨ç¤º
                if (currentUser.photoURL) {
                    userAvatar.src = currentUser.photoURL;
                    userAvatar.style.display = 'block';
                } else {
                    userAvatar.style.display = 'none';
                }
                
                // AIåˆ†æã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
                loginRequired.style.display = 'none';
                aiAnalysisContent.classList.remove('hidden');
            } else {
                // ãƒ­ã‚°ã‚¤ãƒ³å‰ã®ãƒŠãƒ“è¡¨ç¤º
                loginNavView.classList.remove('hidden');
                userNavView.classList.add('hidden');
                
                // ãƒ­ã‚°ã‚¤ãƒ³è¦æ±‚ã‚’è¡¨ç¤º
                loginRequired.style.display = 'block';
                aiAnalysisContent.classList.add('hidden');
            }
        }

        // ã‚µãƒ³ãƒ—ãƒ«ãƒãƒ¼ãƒˆèª­ã¿è¾¼ã¿
        window.loadSampleNote = function(index) {
            document.getElementById('tastingNote').value = sampleNotes[index];
        }

        // AIåˆ†æå®Ÿè¡Œ
        window.analyzeWine = async function() {
            const tastingNote = document.getElementById('tastingNote').value.trim();
            const analyzeBtn = document.getElementById('analyzeBtn');
            const analyzeIcon = document.getElementById('analyzeIcon');
            const analyzeText = document.getElementById('analyzeText');
            const analysisResults = document.getElementById('analysisResults');
            const analysisContent = document.getElementById('analysisContent');

            if (!tastingNote) {
                showStatus('ãƒ†ã‚¤ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒãƒ¼ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            if (!currentUser) {
                showStatus('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™', 'error');
                return;
            }

            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹
            analyzeBtn.disabled = true;
            analyzeIcon.innerHTML = '<div class="loading-spinner"></div>';
            analyzeText.textContent = 'åˆ†æä¸­...';

            try {
                // AIåˆ†æã‚’å®Ÿè¡Œï¼ˆãƒ¢ãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰
                const analysis = await performAIAnalysis(tastingNote);
                
                // çµæœã‚’è¡¨ç¤º
                displayAnalysisResults(analysis);
                analysisResults.classList.remove('hidden');
                
                // åˆ†æå±¥æ­´ã‚’Firestoreã«ä¿å­˜
                await saveAnalysisHistory(tastingNote, analysis);
                
                showStatus('AIåˆ†æãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
                
            } catch (error) {
                console.error('AIåˆ†æã‚¨ãƒ©ãƒ¼:', error);
                analysisContent.innerHTML = `
                    <div class="error-message">
                        <h4>âš ï¸ åˆ†æã‚¨ãƒ©ãƒ¼</h4>
                        <p>AIåˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚</p>
                        <p>ã‚¨ãƒ©ãƒ¼è©³ç´°: ${error.message}</p>
                    </div>
                `;
                analysisResults.classList.remove('hidden');
                showStatus('åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            } finally {
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è§£é™¤
                analyzeBtn.disabled = false;
                analyzeIcon.textContent = 'ğŸ¤–';
                analyzeText.textContent = 'AIåˆ†æã‚’é–‹å§‹';
            }
        }

        // AIåˆ†æå®Ÿè¡Œï¼ˆãƒ¢ãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Ÿè£…ï¼‰
        async function performAIAnalysis(tastingNote) {
            // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆé…å»¶
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // ãƒ†ã‚­ã‚¹ãƒˆã®è¤‡é›‘ã•ã‚’åˆ†æ
            const wordCount = tastingNote.split(/\s+/).length;
            const hasColorDescription = /è‰²|ãƒ«ãƒ“ãƒ¼|ã‚¬ãƒ¼ãƒãƒƒãƒˆ|ç´«|é€æ˜/.test(tastingNote);
            const hasAromaDescription = /é¦™ã‚Š|ã‚¢ãƒ­ãƒ|æœå®Ÿ|èŠ±|ã‚¹ãƒ‘ã‚¤ã‚¹|ãƒãƒ‹ãƒ©|ã‚ªãƒ¼ã‚¯/.test(tastingNote);
            const hasTasteDescription = /å‘³|é…¸å‘³|ç”˜å‘³|ã‚¿ãƒ³ãƒ‹ãƒ³|ãƒœãƒ‡ã‚£|å£å½“ãŸã‚Š/.test(tastingNote);
            const hasFinishDescription = /ä½™éŸ»|ãƒ•ã‚£ãƒ‹ãƒƒã‚·ãƒ¥|å¾Œå‘³/.test(tastingNote);
            
            // å°‚é–€ç”¨èªã®ä½¿ç”¨åº¦
            const technicalTerms = ['ã‚¿ãƒ³ãƒ‹ãƒ³', 'ã‚¢ãƒ­ãƒ', 'ãƒ–ãƒ¼ã‚±', 'ãƒ•ã‚£ãƒ‹ãƒƒã‚·ãƒ¥', 'ãƒœãƒ‡ã‚£', 'ã‚¢ã‚·ãƒ‡ã‚£ãƒ†ã‚£', 'ãƒŸãƒãƒ©ãƒ«'];
            const technicalTermCount = technicalTerms.filter(term => tastingNote.includes(term)).length;
            
            // åˆ†æãƒ¬ãƒ™ãƒ«åˆ¤å®š
            let level = 'beginner';
            let confidence = 60;
            
            if (wordCount > 50 && technicalTermCount >= 3 && hasColorDescription && hasAromaDescription && hasTasteDescription) {
                level = 'advanced';
                confidence = 90;
            } else if (wordCount > 20 && technicalTermCount >= 1 && (hasAromaDescription || hasTasteDescription)) {
                level = 'intermediate';
                confidence = 75;
            }

            return {
                level: level,
                confidence: confidence,
                wordCount: wordCount,
                technicalTermCount: technicalTermCount,
                hasColorDescription: hasColorDescription,
                hasAromaDescription: hasAromaDescription,
                hasTasteDescription: hasTasteDescription,
                hasFinishDescription: hasFinishDescription,
                suggestions: generateSuggestions(level, tastingNote),
                wineStyle: analyzeWineStyle(tastingNote),
                improvements: generateImprovements(level)
            };
        }

        // ãƒ¯ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«åˆ†æ
        function analyzeWineStyle(note) {
            const redKeywords = ['èµ¤', 'ãƒ«ãƒ“ãƒ¼', 'ã‚¬ãƒ¼ãƒãƒƒãƒˆ', 'ã‚¿ãƒ³ãƒ‹ãƒ³', 'ã‚«ã‚·ã‚¹', 'ãƒ–ãƒ©ãƒƒã‚¯ãƒ™ãƒªãƒ¼'];
            const whiteKeywords = ['ç™½', 'é»„é‡‘', 'ã‚·ãƒˆãƒ©ã‚¹', 'é…¸å‘³', 'çˆ½ã‚„ã‹', 'ãƒŸãƒãƒ©ãƒ«'];
            const sparklingKeywords = ['æ³¡', 'ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒªãƒ³ã‚°', 'ã‚·ãƒ¥ãƒ¯ã‚·ãƒ¥ãƒ¯', 'ç™ºæ³¡'];
            
            const redScore = redKeywords.filter(keyword => note.includes(keyword)).length;
            const whiteScore = whiteKeywords.filter(keyword => note.includes(keyword)).length;
            const sparklingScore = sparklingKeywords.filter(keyword => note.includes(keyword)).length;
            
            if (sparklingScore > 0) return 'ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒªãƒ³ã‚°ãƒ¯ã‚¤ãƒ³';
            if (redScore > whiteScore) return 'èµ¤ãƒ¯ã‚¤ãƒ³';
            if (whiteScore > 0) return 'ç™½ãƒ¯ã‚¤ãƒ³';
            return 'ä¸æ˜';
        }

        // æ”¹å–„ææ¡ˆç”Ÿæˆ
        function generateSuggestions(level, note) {
            const suggestions = [];
            
            if (level === 'beginner') {
                suggestions.push({
                    title: 'å¤–è¦³ã®è¨˜è¿°ã‚’è¿½åŠ ',
                    content: 'ãƒ¯ã‚¤ãƒ³ã®è‰²ã€é€æ˜åº¦ã€ç²˜æ€§ã«ã¤ã„ã¦è©³ã—ãè¨˜è¿°ã—ã¦ã¿ã¾ã—ã‚‡ã†'
                });
                suggestions.push({
                    title: 'é¦™ã‚Šã®è¡¨ç¾ã‚’è±Šã‹ã«',
                    content: 'æœå®Ÿã€èŠ±ã€ã‚¹ãƒ‘ã‚¤ã‚¹ãªã©å…·ä½“çš„ãªé¦™ã‚Šã®è¦ç´ ã‚’æ¢ã—ã¦ã¿ã¦ãã ã•ã„'
                });
            } else if (level === 'intermediate') {
                suggestions.push({
                    title: 'ãƒ•ã‚£ãƒ‹ãƒƒã‚·ãƒ¥ã®è¨˜è¿°',
                    content: 'ä½™éŸ»ã®é•·ã•ã‚„å¤‰åŒ–ã«ã¤ã„ã¦è¨˜è¿°ã™ã‚‹ã¨ã€ã‚ˆã‚Šå®Œå…¨ãªè©•ä¾¡ã«ãªã‚Šã¾ã™'
                });
                suggestions.push({
                    title: 'æ§‹é€ ã®åˆ†æ',
                    content: 'é…¸å‘³ã€ã‚¿ãƒ³ãƒ‹ãƒ³ã€ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ„Ÿã®ãƒãƒ©ãƒ³ã‚¹ã«ã¤ã„ã¦è¨€åŠã—ã¦ã¿ã¦ãã ã•ã„'
                });
            } else {
                suggestions.push({
                    title: 'æ™‚é–“çµŒéã§ã®å¤‰åŒ–',
                    content: 'ã‚°ãƒ©ã‚¹ã®ä¸­ã§ã®é¦™ã‚Šã‚„å‘³ã®å¤‰åŒ–ã«ã¤ã„ã¦è¦³å¯Ÿã—ã¦ã¿ã¦ãã ã•ã„'
                });
                suggestions.push({
                    title: 'ãƒšã‚¢ãƒªãƒ³ã‚°ææ¡ˆ',
                    content: 'ã“ã®ãƒ¯ã‚¤ãƒ³ã«åˆã†æ–™ç†ã‚„é£Ÿæã«ã¤ã„ã¦è€ƒå¯Ÿã‚’åŠ ãˆã¦ã¿ã¾ã—ã‚‡ã†'
                });
            }
            
            return suggestions;
        }

        // æ”¹å–„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆ
        function generateImprovements(level) {
            const improvements = {
                beginner: [
                    'è‰²ã‚’è¦³å¯Ÿã™ã‚‹æ™‚ã¯ã€ç™½ã„èƒŒæ™¯ã§45åº¦ã«å‚¾ã‘ã¦è¦‹ã¦ã¿ã¾ã—ã‚‡ã†',
                    'é¦™ã‚Šã¯æœ€åˆã«è»½ãå›ã—ã¦ã‹ã‚‰ã€æ·±ãå—…ã„ã§ã¿ã¦ãã ã•ã„',
                    'å‘³ã‚ã„ã¯å£ã®ä¸­å…¨ä½“ã§æ„Ÿã˜ã€æ¸©åº¦å¤‰åŒ–ã‚‚æ„è­˜ã—ã¦ã¿ã¾ã—ã‚‡ã†'
                ],
                intermediate: [
                    'ç¬¬ä¸€ã‚¢ãƒ­ãƒï¼ˆæœå®Ÿï¼‰ã¨ç¬¬äºŒã‚¢ãƒ­ãƒï¼ˆç™ºé…µãƒ»ç†Ÿæˆï¼‰ã‚’åŒºåˆ¥ã—ã¦ã¿ã¾ã—ã‚‡ã†',
                    'ã‚¿ãƒ³ãƒ‹ãƒ³ã®è³ªï¼ˆç²—ã„ã‹æ»‘ã‚‰ã‹ã‹ï¼‰ã«ã¤ã„ã¦è©•ä¾¡ã—ã¦ã¿ã¦ãã ã•ã„',
                    'é…¸å‘³ã®ç¨®é¡ï¼ˆãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã€ã¾ã‚ã‚„ã‹ç­‰ï¼‰ã‚’è¡¨ç¾ã—ã¦ã¿ã¾ã—ã‚‡ã†'
                ],
                advanced: [
                    'ãƒ†ãƒ­ãƒ¯ãƒ¼ãƒ«ã®è¡¨ç¾ã«ã¤ã„ã¦è€ƒå¯Ÿã‚’æ·±ã‚ã¦ã¿ã¦ãã ã•ã„',
                    'é†¸é€ æŠ€è¡“ãŒå‘³ã‚ã„ã«ä¸ãˆã‚‹å½±éŸ¿ã«ã¤ã„ã¦åˆ†æã—ã¦ã¿ã¾ã—ã‚‡ã†',
                    'ä»–ã®ãƒ´ã‚£ãƒ³ãƒ†ãƒ¼ã‚¸ã¨ã®æ¯”è¼ƒã‚’å«ã‚ã¦ã¿ã¦ãã ã•ã„'
                ]
            };
            
            return improvements[level] || improvements.beginner;
        }

        // åˆ†æçµæœè¡¨ç¤º
        function displayAnalysisResults(analysis) {
            const analysisContent = document.getElementById('analysisContent');
            
            const levelNames = {
                beginner: 'åˆç´š',
                intermediate: 'ä¸­ç´š', 
                advanced: 'ä¸Šç´š'
            };
            
            const levelColors = {
                beginner: '#ef4444',
                intermediate: '#f59e0b',
                advanced: '#10b981'
            };

            analysisContent.innerHTML = `
                <div class="analysis-result">
                    <div class="analysis-section">
                        <h4>ğŸ“ˆ ãƒ†ã‚¤ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒ¬ãƒ™ãƒ«</h4>
                        <div class="analysis-content">
                            <p><strong>${levelNames[analysis.level]}ãƒ¬ãƒ™ãƒ«</strong> (ä¿¡é ¼åº¦: ${analysis.confidence}%)</p>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: ${analysis.confidence}%; background-color: ${levelColors[analysis.level]};"></div>
                            </div>
                            <p style="margin-top: 8px; font-size: 14px; color: var(--text-secondary);">
                                å˜èªæ•°: ${analysis.wordCount} | å°‚é–€ç”¨èª: ${analysis.technicalTermCount}å€‹ä½¿ç”¨
                            </p>
                        </div>
                    </div>
                    
                    <div class="analysis-section">
                        <h4>ğŸ· ãƒ¯ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«äºˆæ¸¬</h4>
                        <div class="analysis-content">
                            <p>${analysis.wineStyle}</p>
                        </div>
                    </div>
                    
                    <div class="analysis-section">
                        <h4>ğŸ¯ è©•ä¾¡è¦ç´ </h4>
                        <div class="analysis-content">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                                <div>ğŸ‘ï¸ å¤–è¦³æå†™: ${analysis.hasColorDescription ? 'âœ…' : 'âŒ'}</div>
                                <div>ğŸ‘ƒ é¦™ã‚Šæå†™: ${analysis.hasAromaDescription ? 'âœ…' : 'âŒ'}</div>
                                <div>ğŸ‘… å‘³ã‚ã„æå†™: ${analysis.hasTasteDescription ? 'âœ…' : 'âŒ'}</div>
                                <div>â±ï¸ ãƒ•ã‚£ãƒ‹ãƒƒã‚·ãƒ¥: ${analysis.hasFinishDescription ? 'âœ…' : 'âŒ'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="analysis-section">
                        <h4>ğŸ’¡ æ”¹å–„ææ¡ˆ</h4>
                        <div class="wine-recommendations">
                            ${analysis.suggestions.map(suggestion => `
                                <div class="recommendation-card">
                                    <h5>${suggestion.title}</h5>
                                    <p>${suggestion.content}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="improvement-tips">
                        <h4>ğŸ“ æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¸ã®ãƒ’ãƒ³ãƒˆ</h4>
                        ${analysis.improvements.map(tip => `
                            <div class="tip-item">
                                <span class="tip-icon">ğŸ’¡</span>
                                <span>${tip}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // åˆ†æå±¥æ­´ä¿å­˜
        async function saveAnalysisHistory(note, analysis) {
            if (!currentUser) return;
            
            try {
                await addDoc(collection(db, 'ai_analysis_history'), {
                    userId: currentUser.uid,
                    tastingNote: note,
                    analysisResult: analysis,
                    createdAt: serverTimestamp()
                });
            } catch (error) {
                console.error('åˆ†æå±¥æ­´ã®ä¿å­˜ã«å¤±æ•—:', error);
            }
        }

        // å…±é€šã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        window.signInWithGoogle = async function() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                showStatus('ãƒ­ã‚°ã‚¤ãƒ³ã«æˆåŠŸã—ã¾ã—ãŸ', 'success');
            } catch (error) {
                console.error('Google login failed:', error);
                showStatus('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }

        window.confirmSignOut = function() {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                firebaseSignOut(auth);
            }
        }

        function showStatus(message, type) {
            const statusEl = document.getElementById('authNavStatus');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = `auth-status ${type}`;
                statusEl.classList.remove('hidden');
                
                setTimeout(() => {
                    statusEl.classList.add('hidden');
                }, 3000);
            }
        }

        // ãƒ†ãƒ¼ãƒã¨ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®åˆæœŸåŒ–
        function initTheme() {
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = document.querySelector('.theme-icon');
            
            const savedTheme = localStorage.getItem('theme') || 
                (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            
            setTheme(savedTheme);
            
            themeToggle.addEventListener('click', () => {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                setTheme(newTheme);
                localStorage.setItem('theme', newTheme);
            });
            
            function setTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                themeIcon.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
            }
        }

        function initMobileMenu() {
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const navbarMenu = document.getElementById('navbarMenu');
            
            if (mobileMenuToggle && navbarMenu) {
                mobileMenuToggle.addEventListener('click', () => {
                    mobileMenuToggle.classList.toggle('active');
                    navbarMenu.classList.toggle('active');
                });
                
                document.addEventListener('click', (e) => {
                    if (!mobileMenuToggle.contains(e.target) && !navbarMenu.contains(e.target)) {
                        mobileMenuToggle.classList.remove('active');
                        navbarMenu.classList.remove('active');
                    }
                });
            }
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initTheme();
            initMobileMenu();
        });
    </script>
</body>
</html>