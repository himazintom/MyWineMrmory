<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIÂàÜÊûê - MyWineMemory</title>
    
    <!-- PWAË®≠ÂÆö -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="WineMemory">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    
    <!-- È´òÂ∫¶„Å™„Çπ„Çø„Ç§„É´ -->
    <link rel="stylesheet" href="/advanced-style.css">
    
    <style>
        .ai-analysis-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .ai-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }
        
        .ai-input-section {
            margin-bottom: 30px;
        }
        
        .tasting-input {
            width: 100%;
            min-height: 120px;
            padding: 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text-color);
            font-size: 16px;
            resize: vertical;
            transition: border-color 0.3s ease;
        }
        
        .tasting-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .analyze-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 16px;
        }
        
        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        
        .analyze-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .analysis-result {
            margin-top: 24px;
            padding: 20px;
            background: var(--secondary-bg);
            border-radius: 8px;
            border-left: 4px solid var(--accent-color);
        }
        
        .analysis-section {
            margin-bottom: 20px;
        }
        
        .analysis-section h4 {
            color: var(--primary-color);
            margin-bottom: 8px;
            font-size: 18px;
        }
        
        .analysis-content {
            line-height: 1.6;
            color: var(--text-color);
        }
        
        .confidence-bar {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981);
            transition: width 0.5s ease;
        }
        
        .wine-recommendations {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }
        
        .recommendation-card {
            background: var(--card-bg);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .recommendation-card h5 {
            color: var(--primary-color);
            margin-bottom: 8px;
        }
        
        .improvement-tips {
            background: var(--info-bg);
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }
        
        .improvement-tips h4 {
            color: var(--info-color);
            margin-bottom: 12px;
        }
        
        .tip-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .tip-icon {
            color: var(--success-color);
            margin-top: 2px;
        }
        
        .error-message {
            background: var(--error-bg);
            color: var(--error-color);
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }
        
        .sample-notes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }
        
        .sample-note {
            padding: 12px;
            background: var(--secondary-bg);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        
        .sample-note:hover {
            border-color: var(--primary-color);
            background: var(--card-bg);
        }
        
        .sample-note-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 4px;
        }
        
        .sample-note-text {
            font-size: 14px;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <!-- Professional Navigation Header -->
    <nav class="main-navbar">
        <div class="navbar-container">
            <div class="navbar-brand">
                <span class="brand-icon">üç∑</span>
                <span class="brand-text">MyWineMemory</span>
            </div>
            
            <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="„É°„Éã„É•„Éº„ÇíÈñã„Åè">
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
            </button>
            
            <div class="navbar-menu" id="navbarMenu">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a href="/" class="nav-link">
                            <span class="nav-icon">üè†</span>
                            <span class="nav-text">„Éõ„Éº„É†</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/quiz.html" class="nav-link">
                            <span class="nav-icon">üß†</span>
                            <span class="nav-text">„ÇØ„Ç§„Ç∫</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/analytics.html" class="nav-link">
                            <span class="nav-icon">üìä</span>
                            <span class="nav-text">ÂàÜÊûê</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/ai-evaluation.html" class="nav-link active">
                            <span class="nav-icon">ü§ñ</span>
                            <span class="nav-text">AIÂàÜÊûê</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/learning-progress.html" class="nav-link">
                            <span class="nav-icon">üìà</span>
                            <span class="nav-text">Â≠¶ÁøíÈÄ≤Êçó</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/skill-tree.html" class="nav-link">
                            <span class="nav-icon">üå≥</span>
                            <span class="nav-text">„Çπ„Ç≠„É´„ÉÑ„É™„Éº</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <button id="theme-toggle" class="theme-toggle nav-link nav-button" aria-label="„ÉÜ„Éº„ÉûÂàá„ÇäÊõø„Åà">
                            <span class="theme-icon">üåô</span>
                            <span class="nav-text">„ÉÜ„Éº„Éû</span>
                        </button>
                    </li>
                    <li class="nav-item auth-nav" id="authNavItem">
                        <!-- „É≠„Ç∞„Ç§„É≥ÂâçË°®Á§∫ -->
                        <div id="loginNavView" class="auth-nav-content">
                            <button class="nav-link nav-button auth-button" onclick="signInWithGoogle()">
                                <span class="nav-icon">üë§</span>
                                <span class="nav-text">„É≠„Ç∞„Ç§„É≥</span>
                            </button>
                        </div>
                        
                        <!-- „É≠„Ç∞„Ç§„É≥ÂæåË°®Á§∫ -->
                        <div id="userNavView" class="auth-nav-content hidden">
                            <div class="user-nav-info">
                                <img id="userAvatar" class="user-avatar" src="" alt="„É¶„Éº„Ç∂„Éº„Ç¢„Éê„Çø„Éº" style="display: none;">
                                <div class="user-details">
                                    <span class="user-name" id="userNavName">„É¶„Éº„Ç∂„Éº</span>
                                    <span class="user-email" id="userNavEmail"></span>
                                </div>
                                <button id="privacyToggle" class="privacy-toggle-btn" onclick="togglePrivacy()" title="Ë®òÈå≤„ÅÆÂÖ¨Èñã/ÈùûÂÖ¨Èñã„ÇíÂàá„ÇäÊõø„Åà">
                                    <span id="privacyIcon">üîí</span>
                                </button>
                                <button class="logout-btn" onclick="confirmSignOut()" title="„É≠„Ç∞„Ç¢„Ç¶„Éà">
                                    <span>üö™</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- „Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫ -->
                        <div id="authNavStatus" class="auth-status hidden"></div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="main-container">
        <div class="ai-analysis-container">
            <div class="ai-card">
                <h1>ü§ñ AI „ÉÜ„Ç§„Çπ„ÉÜ„Ç£„É≥„Ç∞ÂàÜÊûê</h1>
                <p>„ÅÇ„Å™„Åü„ÅÆ„ÉÜ„Ç§„Çπ„ÉÜ„Ç£„É≥„Ç∞„Éé„Éº„Éà„ÇíAI„ÅåÂàÜÊûê„Åó„ÄÅÂ∞ÇÈñÄÁöÑ„Å™Ë©ï‰æ°„Å®„Ç¢„Éâ„Éê„Ç§„Çπ„ÇíÊèê‰æõ„Åó„Åæ„Åô</p>
            </div>
            
            <!-- „É≠„Ç∞„Ç§„É≥ÂøÖË¶Å„É°„ÉÉ„Çª„Éº„Ç∏ -->
            <div id="loginRequired" class="ai-card" style="text-align: center;">
                <h2>üîê „É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô</h2>
                <p>AIÂàÜÊûêÊ©üËÉΩ„ÇíÂà©Áî®„Åô„Çã„Å´„ÅØ„ÄÅ„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                <button class="btn primary-btn" onclick="signInWithGoogle()">
                    <span class="btn-icon">G</span>
                    Google„Åß„É≠„Ç∞„Ç§„É≥
                </button>
            </div>
            
            <!-- AIÂàÜÊûê„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
            <div id="aiAnalysisContent" class="hidden">
                <!-- „Çµ„É≥„Éó„É´„Éé„Éº„Éà -->
                <div class="ai-card">
                    <h3>üìù „Çµ„É≥„Éó„É´„ÉÜ„Ç§„Çπ„ÉÜ„Ç£„É≥„Ç∞„Éé„Éº„Éà</h3>
                    <p>‰ª•‰∏ã„ÅÆ„Çµ„É≥„Éó„É´„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Ë©¶„Åó„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑÔºö</p>
                    <div class="sample-notes">
                        <div class="sample-note" onclick="loadSampleNote(0)">
                            <div class="sample-note-title">ÂàùÂøÉËÄÖ„É¨„Éô„É´</div>
                            <div class="sample-note-text">ÁæéÂë≥„Åó„ÅÑËµ§„ÉØ„Ç§„É≥„ÄÇÂ∞ë„ÅóÈÖ∏„Å£„Å±„ÅÑ„Åë„Å©È£≤„Åø„ÇÑ„Åô„ÅÑ„ÄÇ</div>
                        </div>
                        <div class="sample-note" onclick="loadSampleNote(1)">
                            <div class="sample-note-title">‰∏≠Á¥ö„É¨„Éô„É´</div>
                            <div class="sample-note-text">Ê∑±„ÅÑ„É´„Éì„ÉºËâ≤„ÄÇ„Éñ„É©„ÉÉ„ÇØ„Éô„É™„Éº„ÅÆÈ¶ô„Çä„ÅåÂº∑„Åè„ÄÅ„Çø„É≥„Éã„É≥„Åå„Åó„Å£„Åã„Çä„Åó„Å¶„ÅÑ„Çã„ÄÇ</div>
                        </div>
                        <div class="sample-note" onclick="loadSampleNote(2)">
                            <div class="sample-note-title">‰∏äÁ¥ö„É¨„Éô„É´</div>
                            <div class="sample-note-text">ÊøÉ„ÅÑ„Ç¨„Éº„Éç„ÉÉ„ÉàËâ≤„ÄÅ„Ç®„ÉÉ„Ç∏„ÅØÂÉÖ„Åã„Å´„Ç™„É¨„É≥„Ç∏„Åå„Åã„Å£„Å¶„ÅÑ„Çã„ÄÇÁ¨¨‰∏Ä„Ç¢„É≠„Éû„ÅØ„Ç´„Ç∑„Çπ„Å®„Éñ„É©„ÉÉ„ÇØ„Éô„É™„Éº„ÄÅÁ¨¨‰∫å„Ç¢„É≠„Éû„Åß„Éê„Éã„É©„Å®„Çπ„Éë„Ç§„Çπ„ÅÆ„Éã„É•„Ç¢„É≥„Çπ„ÄÇ</div>
                        </div>
                    </div>
                </div>
                
                <!-- „ÉÜ„Ç§„Çπ„ÉÜ„Ç£„É≥„Ç∞„Éé„Éº„ÉàÂÖ•Âäõ -->
                <div class="ai-card">
                    <div class="ai-input-section">
                        <h3>üç∑ „ÉÜ„Ç§„Çπ„ÉÜ„Ç£„É≥„Ç∞„Éé„Éº„Éà„ÇíÂÖ•Âäõ</h3>
                        <textarea 
                            id="tastingNote" 
                            class="tasting-input"
                            placeholder="„ÉØ„Ç§„É≥„ÅÆÂ§ñË¶≥„ÄÅÈ¶ô„Çä„ÄÅÂë≥„Çè„ÅÑ„ÄÅ„Éï„Ç£„Éã„ÉÉ„Ç∑„É•„Å´„Å§„ÅÑ„Å¶Ëá™Áî±„Å´Ë®òËø∞„Åó„Å¶„Åè„Å†„Åï„ÅÑ&#10;&#10;‰æãÔºö&#10;„ÉªÂ§ñË¶≥ÔºöÊ∑±„ÅÑ„É´„Éì„ÉºËâ≤„ÄÅÈÄèÊòéÂ∫¶„ÅØÈ´ò„ÅÑ&#10;„ÉªÈ¶ô„ÇäÔºö„Éñ„É©„ÉÉ„ÇØ„Éô„É™„Éº„ÄÅ„Ç´„Ç∑„Çπ„ÅÆÊûúÂÆüÈ¶ô„Å´„ÄÅ„Éê„Éã„É©„ÇÑ„Çπ„Éë„Ç§„Çπ„ÅÆ„Éã„É•„Ç¢„É≥„Çπ&#10;„ÉªÂë≥„Çè„ÅÑÔºöË±ä„Åã„Å™ÊûúÂÆüÂë≥„ÄÅ„Åó„Å£„Åã„Çä„Åó„Åü„Çø„É≥„Éã„É≥„ÄÅÈÅ©Â∫¶„Å™ÈÖ∏Âë≥&#10;„Éª„Éï„Ç£„Éã„ÉÉ„Ç∑„É•ÔºöÈï∑„Åè„ÄÅ‰ΩôÈüª„Å´ÂøÉÂú∞„Çà„ÅÑ„Çπ„Éë„Ç§„ÇπÊÑü"
                        ></textarea>
                        <button id="analyzeBtn" class="analyze-btn" onclick="analyzeWine()">
                            <span id="analyzeIcon">ü§ñ</span>
                            <span id="analyzeText">AIÂàÜÊûê„ÇíÈñãÂßã</span>
                        </button>
                    </div>
                </div>
                
                <!-- ÂàÜÊûêÁµêÊûú -->
                <div id="analysisResults" class="ai-card hidden">
                    <h3>üìä AIÂàÜÊûêÁµêÊûú</h3>
                    <div id="analysisContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK „Å® JavaScript -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut as firebaseSignOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // FirebaseË®≠ÂÆö
        const firebaseConfig = {
            apiKey: "AIzaSyB6jnGUsdR9JDTZoDUq_QhM4Gr_gLVp3qA",
            authDomain: "mywinememory.firebaseapp.com",
            projectId: "mywinememory",
            storageBucket: "mywinememory.firebasestorage.app",
            messagingSenderId: "179280253269",
            appId: "1:179280253269:web:58330b5938412fafc21fdc",
            measurementId: "G-PP1B5425FD"
        };

        // FirebaseÂàùÊúüÂåñ
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let currentUser = null;

        // „Çµ„É≥„Éó„É´„Éé„Éº„Éà
        const sampleNotes = [
            "ÁæéÂë≥„Åó„ÅÑËµ§„ÉØ„Ç§„É≥„ÄÇÂ∞ë„ÅóÈÖ∏„Å£„Å±„ÅÑ„Åë„Å©È£≤„Åø„ÇÑ„Åô„ÅÑ„ÄÇ„Éï„É´„Éº„ÉÑ„ÅÆÂë≥„Åå„Åô„Çã„ÄÇ",
            "Ê∑±„ÅÑ„É´„Éì„ÉºËâ≤„ÄÇ„Éñ„É©„ÉÉ„ÇØ„Éô„É™„Éº„ÅÆÈ¶ô„Çä„ÅåÂº∑„Åè„ÄÅ„Çø„É≥„Éã„É≥„Åå„Åó„Å£„Åã„Çä„Åó„Å¶„ÅÑ„Çã„ÄÇÈÖ∏Âë≥„Å®„ÅÆ„Éê„É©„É≥„Çπ„ÅåËâØ„ÅÑ„ÄÇ",
            "ÊøÉ„ÅÑ„Ç¨„Éº„Éç„ÉÉ„ÉàËâ≤„ÄÅ„Ç®„ÉÉ„Ç∏„ÅØÂÉÖ„Åã„Å´„Ç™„É¨„É≥„Ç∏„Åå„Åã„Å£„Å¶„ÅÑ„Çã„ÄÇÁ¨¨‰∏Ä„Ç¢„É≠„Éû„ÅØ„Ç´„Ç∑„Çπ„Å®„Éñ„É©„ÉÉ„ÇØ„Éô„É™„Éº„ÄÅÁ¨¨‰∫å„Ç¢„É≠„Éû„Åß„Éê„Éã„É©„Å®„Çπ„Éë„Ç§„Çπ„ÅÆ„Éã„É•„Ç¢„É≥„Çπ„ÄÇÂè£ÂΩì„Åü„Çä„ÅØÊªë„Çâ„Åã„Åß„ÄÅÂáùÁ∏Æ„Åó„ÅüÊûúÂÆüÂë≥„Å®„Ç∑„É´„Ç≠„Éº„Å™„Çø„É≥„Éã„É≥„ÅåË™øÂíå„Åó„Å¶„ÅÑ„Çã„ÄÇ„Éï„Ç£„Éã„ÉÉ„Ç∑„É•„ÅØÈï∑„Åè„ÄÅ‰ΩôÈüª„Å´„ÉÄ„Éº„ÇØ„ÉÅ„Éß„Ç≥„É¨„Éº„Éà„Å®„Ç≥„Éº„Éí„Éº„ÅÆÈ¶ô„Çä„ÅåÊÆã„Çã„ÄÇ"
        ];

        // Ë™çË®ºÁä∂ÊÖã„ÅÆÁõ£Ë¶ñ
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            updateUI();
        });

        // UIÊõ¥Êñ∞
        function updateUI() {
            const loginNavView = document.getElementById('loginNavView');
            const userNavView = document.getElementById('userNavView');
            const userNavName = document.getElementById('userNavName');
            const userNavEmail = document.getElementById('userNavEmail');
            const userAvatar = document.getElementById('userAvatar');
            const loginRequired = document.getElementById('loginRequired');
            const aiAnalysisContent = document.getElementById('aiAnalysisContent');

            if (currentUser) {
                // „É≠„Ç∞„Ç§„É≥Âæå„ÅÆ„Éä„ÉìË°®Á§∫
                loginNavView.classList.add('hidden');
                userNavView.classList.remove('hidden');
                
                // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíË®≠ÂÆö
                userNavName.textContent = currentUser.displayName || '„É¶„Éº„Ç∂„Éº';
                userNavEmail.textContent = currentUser.email || '';
                
                // „Ç¢„Éê„Çø„ÉºÁîªÂÉè„Åå„ÅÇ„Çå„Å∞Ë°®Á§∫
                if (currentUser.photoURL) {
                    userAvatar.src = currentUser.photoURL;
                    userAvatar.style.display = 'block';
                } else {
                    userAvatar.style.display = 'none';
                }
                
                // AIÂàÜÊûê„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíË°®Á§∫
                loginRequired.style.display = 'none';
                aiAnalysisContent.classList.remove('hidden');
            } else {
                // „É≠„Ç∞„Ç§„É≥Ââç„ÅÆ„Éä„ÉìË°®Á§∫
                loginNavView.classList.remove('hidden');
                userNavView.classList.add('hidden');
                
                // „É≠„Ç∞„Ç§„É≥Ë¶ÅÊ±Ç„ÇíË°®Á§∫
                loginRequired.style.display = 'block';
                aiAnalysisContent.classList.add('hidden');
            }
        }

        // „Çµ„É≥„Éó„É´„Éé„Éº„ÉàË™≠„ÅøËæº„Åø
        window.loadSampleNote = function(index) {
            document.getElementById('tastingNote').value = sampleNotes[index];
        }

        // AIÂàÜÊûêÂÆüË°å
        window.analyzeWine = async function() {
            const tastingNote = document.getElementById('tastingNote').value.trim();
            const analyzeBtn = document.getElementById('analyzeBtn');
            const analyzeIcon = document.getElementById('analyzeIcon');
            const analyzeText = document.getElementById('analyzeText');
            const analysisResults = document.getElementById('analysisResults');
            const analysisContent = document.getElementById('analysisContent');

            if (!tastingNote) {
                showStatus('„ÉÜ„Ç§„Çπ„ÉÜ„Ç£„É≥„Ç∞„Éé„Éº„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }

            if (!currentUser) {
                showStatus('„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô', 'error');
                return;
            }

            // „É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã
            analyzeBtn.disabled = true;
            analyzeIcon.innerHTML = '<div class="loading-spinner"></div>';
            analyzeText.textContent = 'ÂàÜÊûê‰∏≠...';

            try {
                // AIÂàÜÊûê„ÇíÂÆüË°åÔºà„É¢„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÔºâ
                const analysis = await performAIAnalysis(tastingNote);
                
                // ÁµêÊûú„ÇíË°®Á§∫
                displayAnalysisResults(analysis);
                analysisResults.classList.remove('hidden');
                
                // ÂàÜÊûêÂ±•Ê≠¥„ÇíFirestore„Å´‰øùÂ≠ò
                await saveAnalysisHistory(tastingNote, analysis);
                
                showStatus('AIÂàÜÊûê„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü', 'success');
                
            } catch (error) {
                console.error('AIÂàÜÊûê„Ç®„É©„Éº:', error);
                analysisContent.innerHTML = `
                    <div class="error-message">
                        <h4>‚ö†Ô∏è ÂàÜÊûê„Ç®„É©„Éº</h4>
                        <p>AIÂàÜÊûê‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„ÅèÊôÇÈñì„Çí„Åä„ÅÑ„Å¶ÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                        <p>„Ç®„É©„ÉºË©≥Á¥∞: ${error.message}</p>
                    </div>
                `;
                analysisResults.classList.remove('hidden');
                showStatus('ÂàÜÊûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            } finally {
                // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ëß£Èô§
                analyzeBtn.disabled = false;
                analyzeIcon.textContent = 'ü§ñ';
                analyzeText.textContent = 'AIÂàÜÊûê„ÇíÈñãÂßã';
            }
        }

        // AIÂàÜÊûêÂÆüË°åÔºà„É¢„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÂÆüË£ÖÔºâ
        async function performAIAnalysis(tastingNote) {
            // „Ç∑„Éü„É•„É¨„Éº„ÉàÈÅÖÂª∂
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // „ÉÜ„Ç≠„Çπ„Éà„ÅÆË§áÈõë„Åï„ÇíÂàÜÊûê
            const wordCount = tastingNote.split(/\s+/).length;
            const hasColorDescription = /Ëâ≤|„É´„Éì„Éº|„Ç¨„Éº„Éç„ÉÉ„Éà|Á¥´|ÈÄèÊòé/.test(tastingNote);
            const hasAromaDescription = /È¶ô„Çä|„Ç¢„É≠„Éû|ÊûúÂÆü|Ëä±|„Çπ„Éë„Ç§„Çπ|„Éê„Éã„É©|„Ç™„Éº„ÇØ/.test(tastingNote);
            const hasTasteDescription = /Âë≥|ÈÖ∏Âë≥|ÁîòÂë≥|„Çø„É≥„Éã„É≥|„Éú„Éá„Ç£|Âè£ÂΩì„Åü„Çä/.test(tastingNote);
            const hasFinishDescription = /‰ΩôÈüª|„Éï„Ç£„Éã„ÉÉ„Ç∑„É•|ÂæåÂë≥/.test(tastingNote);
            
            // Â∞ÇÈñÄÁî®Ë™û„ÅÆ‰ΩøÁî®Â∫¶
            const technicalTerms = ['„Çø„É≥„Éã„É≥', '„Ç¢„É≠„Éû', '„Éñ„Éº„Ç±', '„Éï„Ç£„Éã„ÉÉ„Ç∑„É•', '„Éú„Éá„Ç£', '„Ç¢„Ç∑„Éá„Ç£„ÉÜ„Ç£', '„Éü„Éç„É©„É´'];
            const technicalTermCount = technicalTerms.filter(term => tastingNote.includes(term)).length;
            
            // ÂàÜÊûê„É¨„Éô„É´Âà§ÂÆö
            let level = 'beginner';
            let confidence = 60;
            
            if (wordCount > 50 && technicalTermCount >= 3 && hasColorDescription && hasAromaDescription && hasTasteDescription) {
                level = 'advanced';
                confidence = 90;
            } else if (wordCount > 20 && technicalTermCount >= 1 && (hasAromaDescription || hasTasteDescription)) {
                level = 'intermediate';
                confidence = 75;
            }

            return {
                level: level,
                confidence: confidence,
                wordCount: wordCount,
                technicalTermCount: technicalTermCount,
                hasColorDescription: hasColorDescription,
                hasAromaDescription: hasAromaDescription,
                hasTasteDescription: hasTasteDescription,
                hasFinishDescription: hasFinishDescription,
                suggestions: generateSuggestions(level, tastingNote),
                wineStyle: analyzeWineStyle(tastingNote),
                improvements: generateImprovements(level)
            };
        }

        // „ÉØ„Ç§„É≥„Çπ„Çø„Ç§„É´ÂàÜÊûê
        function analyzeWineStyle(note) {
            const redKeywords = ['Ëµ§', '„É´„Éì„Éº', '„Ç¨„Éº„Éç„ÉÉ„Éà', '„Çø„É≥„Éã„É≥', '„Ç´„Ç∑„Çπ', '„Éñ„É©„ÉÉ„ÇØ„Éô„É™„Éº'];
            const whiteKeywords = ['ÁôΩ', 'ÈªÑÈáë', '„Ç∑„Éà„É©„Çπ', 'ÈÖ∏Âë≥', 'ÁàΩ„ÇÑ„Åã', '„Éü„Éç„É©„É´'];
            const sparklingKeywords = ['Ê≥°', '„Çπ„Éë„Éº„ÇØ„É™„É≥„Ç∞', '„Ç∑„É•„ÉØ„Ç∑„É•„ÉØ', 'Áô∫Ê≥°'];
            
            const redScore = redKeywords.filter(keyword => note.includes(keyword)).length;
            const whiteScore = whiteKeywords.filter(keyword => note.includes(keyword)).length;
            const sparklingScore = sparklingKeywords.filter(keyword => note.includes(keyword)).length;
            
            if (sparklingScore > 0) return '„Çπ„Éë„Éº„ÇØ„É™„É≥„Ç∞„ÉØ„Ç§„É≥';
            if (redScore > whiteScore) return 'Ëµ§„ÉØ„Ç§„É≥';
            if (whiteScore > 0) return 'ÁôΩ„ÉØ„Ç§„É≥';
            return '‰∏çÊòé';
        }

        // ÊîπÂñÑÊèêÊ°àÁîüÊàê
        function generateSuggestions(level, note) {
            const suggestions = [];
            
            if (level === 'beginner') {
                suggestions.push({
                    title: 'Â§ñË¶≥„ÅÆË®òËø∞„ÇíËøΩÂä†',
                    content: '„ÉØ„Ç§„É≥„ÅÆËâ≤„ÄÅÈÄèÊòéÂ∫¶„ÄÅÁ≤òÊÄß„Å´„Å§„ÅÑ„Å¶Ë©≥„Åó„ÅèË®òËø∞„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜ'
                });
                suggestions.push({
                    title: 'È¶ô„Çä„ÅÆË°®Áèæ„ÇíË±ä„Åã„Å´',
                    content: 'ÊûúÂÆü„ÄÅËä±„ÄÅ„Çπ„Éë„Ç§„Çπ„Å™„Å©ÂÖ∑‰ΩìÁöÑ„Å™È¶ô„Çä„ÅÆË¶ÅÁ¥†„ÇíÊé¢„Åó„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ'
                });
            } else if (level === 'intermediate') {
                suggestions.push({
                    title: '„Éï„Ç£„Éã„ÉÉ„Ç∑„É•„ÅÆË®òËø∞',
                    content: '‰ΩôÈüª„ÅÆÈï∑„Åï„ÇÑÂ§âÂåñ„Å´„Å§„ÅÑ„Å¶Ë®òËø∞„Åô„Çã„Å®„ÄÅ„Çà„ÇäÂÆåÂÖ®„Å™Ë©ï‰æ°„Å´„Å™„Çä„Åæ„Åô'
                });
                suggestions.push({
                    title: 'ÊßãÈÄ†„ÅÆÂàÜÊûê',
                    content: 'ÈÖ∏Âë≥„ÄÅ„Çø„É≥„Éã„É≥„ÄÅ„Ç¢„É´„Ç≥„Éº„É´ÊÑü„ÅÆ„Éê„É©„É≥„Çπ„Å´„Å§„ÅÑ„Å¶Ë®ÄÂèä„Åó„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ'
                });
            } else {
                suggestions.push({
                    title: 'ÊôÇÈñìÁµåÈÅé„Åß„ÅÆÂ§âÂåñ',
                    content: '„Ç∞„É©„Çπ„ÅÆ‰∏≠„Åß„ÅÆÈ¶ô„Çä„ÇÑÂë≥„ÅÆÂ§âÂåñ„Å´„Å§„ÅÑ„Å¶Ë¶≥ÂØü„Åó„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ'
                });
                suggestions.push({
                    title: '„Éö„Ç¢„É™„É≥„Ç∞ÊèêÊ°à',
                    content: '„Åì„ÅÆ„ÉØ„Ç§„É≥„Å´Âêà„ÅÜÊñôÁêÜ„ÇÑÈ£üÊùê„Å´„Å§„ÅÑ„Å¶ËÄÉÂØü„ÇíÂä†„Åà„Å¶„Åø„Åæ„Åó„Çá„ÅÜ'
                });
            }
            
            return suggestions;
        }

        // ÊîπÂñÑ„Ç¢„Éâ„Éê„Ç§„ÇπÁîüÊàê
        function generateImprovements(level) {
            const improvements = {
                beginner: [
                    'Ëâ≤„ÇíË¶≥ÂØü„Åô„ÇãÊôÇ„ÅØ„ÄÅÁôΩ„ÅÑËÉåÊôØ„Åß45Â∫¶„Å´ÂÇæ„Åë„Å¶Ë¶ã„Å¶„Åø„Åæ„Åó„Çá„ÅÜ',
                    'È¶ô„Çä„ÅØÊúÄÂàù„Å´ËªΩ„ÅèÂõû„Åó„Å¶„Åã„Çâ„ÄÅÊ∑±„ÅèÂóÖ„ÅÑ„Åß„Åø„Å¶„Åè„Å†„Åï„ÅÑ',
                    'Âë≥„Çè„ÅÑ„ÅØÂè£„ÅÆ‰∏≠ÂÖ®‰Ωì„ÅßÊÑü„Åò„ÄÅÊ∏©Â∫¶Â§âÂåñ„ÇÇÊÑèË≠ò„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜ'
                ],
                intermediate: [
                    'Á¨¨‰∏Ä„Ç¢„É≠„ÉûÔºàÊûúÂÆüÔºâ„Å®Á¨¨‰∫å„Ç¢„É≠„ÉûÔºàÁô∫ÈÖµ„ÉªÁÜüÊàêÔºâ„ÇíÂå∫Âà•„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜ',
                    '„Çø„É≥„Éã„É≥„ÅÆË≥™ÔºàÁ≤ó„ÅÑ„ÅãÊªë„Çâ„Åã„ÅãÔºâ„Å´„Å§„ÅÑ„Å¶Ë©ï‰æ°„Åó„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ',
                    'ÈÖ∏Âë≥„ÅÆÁ®ÆÈ°ûÔºà„Éï„É¨„ÉÉ„Ç∑„É•„ÄÅ„Åæ„Çç„ÇÑ„ÅãÁ≠âÔºâ„ÇíË°®Áèæ„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜ'
                ],
                advanced: [
                    '„ÉÜ„É≠„ÉØ„Éº„É´„ÅÆË°®Áèæ„Å´„Å§„ÅÑ„Å¶ËÄÉÂØü„ÇíÊ∑±„ÇÅ„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ',
                    'ÈÜ∏ÈÄ†ÊäÄË°ì„ÅåÂë≥„Çè„ÅÑ„Å´‰∏é„Åà„ÇãÂΩ±Èüø„Å´„Å§„ÅÑ„Å¶ÂàÜÊûê„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜ',
                    '‰ªñ„ÅÆ„É¥„Ç£„É≥„ÉÜ„Éº„Ç∏„Å®„ÅÆÊØîËºÉ„ÇíÂê´„ÇÅ„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ'
                ]
            };
            
            return improvements[level] || improvements.beginner;
        }

        // ÂàÜÊûêÁµêÊûúË°®Á§∫
        function displayAnalysisResults(analysis) {
            const analysisContent = document.getElementById('analysisContent');
            
            const levelNames = {
                beginner: 'ÂàùÁ¥ö',
                intermediate: '‰∏≠Á¥ö', 
                advanced: '‰∏äÁ¥ö'
            };
            
            const levelColors = {
                beginner: '#ef4444',
                intermediate: '#f59e0b',
                advanced: '#10b981'
            };

            analysisContent.innerHTML = `
                <div class="analysis-result">
                    <div class="analysis-section">
                        <h4>üìà „ÉÜ„Ç§„Çπ„ÉÜ„Ç£„É≥„Ç∞„É¨„Éô„É´</h4>
                        <div class="analysis-content">
                            <p><strong>${levelNames[analysis.level]}„É¨„Éô„É´</strong> (‰ø°È†ºÂ∫¶: ${analysis.confidence}%)</p>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: ${analysis.confidence}%; background-color: ${levelColors[analysis.level]};"></div>
                            </div>
                            <p style="margin-top: 8px; font-size: 14px; color: var(--text-secondary);">
                                ÂçòË™ûÊï∞: ${analysis.wordCount} | Â∞ÇÈñÄÁî®Ë™û: ${analysis.technicalTermCount}ÂÄã‰ΩøÁî®
                            </p>
                        </div>
                    </div>
                    
                    <div class="analysis-section">
                        <h4>üç∑ „ÉØ„Ç§„É≥„Çπ„Çø„Ç§„É´‰∫àÊ∏¨</h4>
                        <div class="analysis-content">
                            <p>${analysis.wineStyle}</p>
                        </div>
                    </div>
                    
                    <div class="analysis-section">
                        <h4>üéØ Ë©ï‰æ°Ë¶ÅÁ¥†</h4>
                        <div class="analysis-content">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                                <div>üëÅÔ∏è Â§ñË¶≥ÊèèÂÜô: ${analysis.hasColorDescription ? '‚úÖ' : '‚ùå'}</div>
                                <div>üëÉ È¶ô„ÇäÊèèÂÜô: ${analysis.hasAromaDescription ? '‚úÖ' : '‚ùå'}</div>
                                <div>üëÖ Âë≥„Çè„ÅÑÊèèÂÜô: ${analysis.hasTasteDescription ? '‚úÖ' : '‚ùå'}</div>
                                <div>‚è±Ô∏è „Éï„Ç£„Éã„ÉÉ„Ç∑„É•: ${analysis.hasFinishDescription ? '‚úÖ' : '‚ùå'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="analysis-section">
                        <h4>üí° ÊîπÂñÑÊèêÊ°à</h4>
                        <div class="wine-recommendations">
                            ${analysis.suggestions.map(suggestion => `
                                <div class="recommendation-card">
                                    <h5>${suggestion.title}</h5>
                                    <p>${suggestion.content}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="improvement-tips">
                        <h4>üéì Ê¨°„ÅÆ„É¨„Éô„É´„Å∏„ÅÆ„Éí„É≥„Éà</h4>
                        ${analysis.improvements.map(tip => `
                            <div class="tip-item">
                                <span class="tip-icon">üí°</span>
                                <span>${tip}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // ÂàÜÊûêÂ±•Ê≠¥‰øùÂ≠ò
        async function saveAnalysisHistory(note, analysis) {
            if (!currentUser) return;
            
            try {
                await addDoc(collection(db, 'ai_analysis_history'), {
                    userId: currentUser.uid,
                    tastingNote: note,
                    analysisResult: analysis,
                    createdAt: serverTimestamp()
                });
            } catch (error) {
                console.error('ÂàÜÊûêÂ±•Ê≠¥„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó:', error);
            }
        }

        // ÂÖ±ÈÄö„ÅÆ„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞
        window.signInWithGoogle = async function() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                showStatus('„É≠„Ç∞„Ç§„É≥„Å´ÊàêÂäü„Åó„Åæ„Åó„Åü', 'success');
            } catch (error) {
                console.error('Google login failed:', error);
                showStatus('„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
            }
        }

        window.confirmSignOut = function() {
            if (confirm('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô„ÅãÔºü')) {
                firebaseSignOut(auth);
            }
        }

        function showStatus(message, type) {
            const statusEl = document.getElementById('authNavStatus');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = `auth-status ${type}`;
                statusEl.classList.remove('hidden');
                
                setTimeout(() => {
                    statusEl.classList.add('hidden');
                }, 3000);
            }
        }

        // „ÉÜ„Éº„Éû„Å®„É¢„Éê„Ç§„É´„É°„Éã„É•„Éº„ÅÆÂàùÊúüÂåñ
        function initTheme() {
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = document.querySelector('.theme-icon');
            
            const savedTheme = localStorage.getItem('theme') || 
                (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            
            setTheme(savedTheme);
            
            themeToggle.addEventListener('click', () => {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                setTheme(newTheme);
                localStorage.setItem('theme', newTheme);
            });
            
            function setTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                themeIcon.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            }
        }

        function initMobileMenu() {
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const navbarMenu = document.getElementById('navbarMenu');
            
            if (mobileMenuToggle && navbarMenu) {
                mobileMenuToggle.addEventListener('click', () => {
                    mobileMenuToggle.classList.toggle('active');
                    navbarMenu.classList.toggle('active');
                });
                
                document.addEventListener('click', (e) => {
                    if (!mobileMenuToggle.contains(e.target) && !navbarMenu.contains(e.target)) {
                        mobileMenuToggle.classList.remove('active');
                        navbarMenu.classList.remove('active');
                    }
                });
            }
        }

        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            initTheme();
            initMobileMenu();
        });
    </script>
</body>
</html>